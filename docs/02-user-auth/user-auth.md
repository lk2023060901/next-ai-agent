# 用户认证与权限系统

## 1 注册流程

### 1.1 注册页面

**路由**: `/signup`

**页面布局**: 左右分栏
- 左侧 (50%): 品牌展示区，背景 `Primary-900`，中心显示产品 Logo (120x120px) + 标语 (H2, #FFFFFF) + 功能亮点列表 (3 条, Body, rgba(255,255,255,0.8))
- 右侧 (50%): 注册表单区，背景 Background，垂直居中

#### 1.1.1 注册表单

表单容器宽度: 400px, 居中

**表单元素 (从上到下, 间距 space-5)**:

1. **标题区**
   - "创建账户" (H2, Text-Primary)
   - "已有账户？登录" (Body-sm, Text-Secondary, "登录" 为 Primary-500 链接)
   - 间距: 标题与副标题 space-1

2. **第三方登录按钮组** (垂直排列, 间距 space-3)
   - "使用 GitHub 登录" 按钮 (Secondary 变体, lg 尺寸, 全宽, 左侧 GitHub 图标 20px)
   - "使用 Google 登录" 按钮 (Secondary 变体, lg 尺寸, 全宽, 左侧 Google 图标 20px)

3. **分割线**
   - 水平线 + 居中文字 "或使用邮箱注册" (Caption, Text-Tertiary, 背景 Background padding 0 space-3)

4. **用户名输入框**
   - Label: "用户名" (Body-sm, Text-Primary)
   - Placeholder: "your-username"
   - 验证: 3-30 字符, 仅字母/数字/连字符, 实时去重检查 (debounce 500ms)
   - 右侧图标: 通过 ✓ (Success) / 已占用 ✗ (Danger)

5. **邮箱输入框**
   - Label: "邮箱"
   - Placeholder: "you@example.com"
   - 验证: 邮箱格式, 实时去重检查

6. **密码输入框**
   - Label: "密码"
   - Placeholder: "至少 8 个字符"
   - 右侧: 显示/隐藏切换按钮 (Eye/EyeOff 图标)
   - 下方: 密码强度指示器 (4 格横条)
     - 弱: 1 格红色 (Danger)
     - 中: 2 格橙色 (Warning)
     - 强: 3 格蓝色 (Primary)
     - 极强: 4 格绿色 (Success)
   - 验证: 最少 8 字符, 包含大小写字母和数字

7. **确认密码输入框**
   - Label: "确认密码"
   - 验证: 与密码一致

8. **服务条款勾选**
   - Checkbox + "我已阅读并同意 [服务条款] 和 [隐私政策]" (Body-sm)
   - 链接: Primary-500, 新标签页打开

9. **注册按钮**
   - "创建账户" (Primary 变体, lg 尺寸, 全宽)
   - 点击后: Loading 状态, 按钮内显示 spinner

#### 1.1.2 注册成功反馈

- 注册成功后跳转到邮箱验证页面 `/verify-email`
- 页面居中显示:
  - 邮件图标 (64x64, Primary-300)
  - "请验证您的邮箱" (H2)
  - "我们已向 user@example.com 发送了一封验证邮件" (Body, Text-Secondary)
  - "重新发送" 按钮 (Ghost 变体, 点击后 60 秒冷却, 显示倒计时)
  - "更换邮箱" 链接 (Body-sm, Text-Tertiary)

### 1.2 登录页面

**路由**: `/login`

**布局**: 与注册页面一致 (左右分栏)

#### 1.2.1 登录表单

表单容器宽度: 400px

**表单元素**:

1. **标题区**
   - "欢迎回来" (H2)
   - "还没有账户？注册" (Body-sm)

2. **第三方登录按钮组** (同注册)

3. **分割线**

4. **邮箱输入框**
   - Label: "邮箱"
   - Placeholder: "you@example.com"

5. **密码输入框**
   - Label: "密码"
   - 右侧: 显示/隐藏切换
   - 下方右对齐: "忘记密码？" 链接 (Body-sm, Primary-500)

6. **记住我**
   - Checkbox + "记住我 30 天" (Body-sm)

7. **登录按钮**
   - "登录" (Primary, lg, 全宽)

#### 1.2.2 登录失败反馈

- 邮箱/密码错误: 表单顶部显示红色 Alert ("邮箱或密码错误"), 密码框边框变 Danger
- 账户未验证: 表单顶部显示黄色 Alert ("请先验证邮箱") + "重新发送验证邮件" 链接
- 账户被锁定: 表单顶部显示红色 Alert ("账户已被锁定, 请联系管理员")
- 连续失败 5 次: 显示验证码 (图形验证码或 reCAPTCHA)

### 1.3 忘记密码

**路由**: `/forgot-password`

**表单**:
1. "重置密码" (H2)
2. "输入您的邮箱，我们将发送重置链接" (Body-sm, Text-Secondary)
3. 邮箱输入框
4. "发送重置链接" 按钮 (Primary, lg, 全宽)
5. "返回登录" 链接

**重置密码页面** (`/reset-password?token=xxx`):
1. "设置新密码" (H2)
2. 新密码输入框 (含强度指示器)
3. 确认密码输入框
4. "重置密码" 按钮

---

## 2 权限系统 (RBAC)

### 2.1 角色定义

| 角色 | 代码 | 权限范围 |
|------|------|----------|
| 超级管理员 | `super_admin` | 全局管理 (仅平台方) |
| 组织所有者 | `org_owner` | 组织级全部权限 |
| 组织管理员 | `org_admin` | 组织级管理 (不含删除组织/转让) |
| 工作区管理员 | `ws_admin` | 工作区级全部权限 |
| 工作区成员 | `ws_member` | 工作区内使用 Agent、查看资源 |
| 访客 | `ws_guest` | 只读访问指定资源 |

### 2.2 权限矩阵

| 操作 | super_admin | org_owner | org_admin | ws_admin | ws_member | ws_guest |
|------|:-----------:|:---------:|:---------:|:--------:|:---------:|:--------:|
| 创建组织 | ✓ | ✓ | - | - | - | - |
| 删除组织 | ✓ | ✓ | - | - | - | - |
| 组织设置 | ✓ | ✓ | ✓ | - | - | - |
| 邀请成员 | ✓ | ✓ | ✓ | ✓ | - | - |
| 移除成员 | ✓ | ✓ | ✓ | ✓ | - | - |
| 创建工作区 | ✓ | ✓ | ✓ | - | - | - |
| 删除工作区 | ✓ | ✓ | ✓ | ✓ | - | - |
| 工作区设置 | ✓ | ✓ | ✓ | ✓ | - | - |
| 使用 Agent | ✓ | ✓ | ✓ | ✓ | ✓ | - |
| 管理 Agent | ✓ | ✓ | ✓ | ✓ | - | - |
| 查看会话 | ✓ | ✓ | ✓ | ✓ | ✓ (自己) | ✓ (指定) |
| 管理插件 | ✓ | ✓ | ✓ | ✓ | - | - |
| 查看用量 | ✓ | ✓ | ✓ | ✓ | ✓ (自己) | - |
| 计费管理 | ✓ | ✓ | - | - | - | - |
| 查看审计日志 | ✓ | ✓ | ✓ | - | - | - |

### 2.3 Token 管理

#### 2.3.1 JWT 结构

```json
{
  "sub": "user_id",
  "org_id": "organization_id",
  "ws_id": "workspace_id",
  "role": "ws_member",
  "permissions": ["agent:use", "session:read:own"],
  "iat": 1708300000,
  "exp": 1708386400
}
```

#### 2.3.2 Token 刷新

- Access Token 有效期: 1 小时
- Refresh Token 有效期: 30 天 (勾选"记住我") / 7 天 (未勾选)
- 刷新端点: `POST /api/v1/auth/refresh`
- Refresh Token 使用后立即轮换 (rotation)

---

## 3 个人设置页面

**路由**: `/settings/profile`

### 3.1 页面布局

左侧设置导航 (宽度 200px) + 右侧设置内容

**导航菜单项**:
- 个人资料
- 账户安全
- 通知偏好
- 外观设置
- API 密钥
- 已连接账户

### 3.2 个人资料

#### 3.2.1 头像区

- 头像: xl 尺寸 (96x96px), radius-full
- hover 显示半透明遮罩 + 相机图标
- 点击打开文件选择器 (accept: image/png, image/jpeg, image/webp)
- 限制: 最大 2MB
- 上传后: MinIO 存储, 生成 3 尺寸 (32/64/128px)
- 头像右下方: "更换头像" 按钮 (Ghost, sm)

#### 3.2.2 基础信息表单

2 列布局, 间距 space-6:

| 字段 | 类型 | 验证 | 位置 |
|------|------|------|------|
| 用户名 | Input (disabled, 灰底) | - | 左列 |
| 显示名称 | Input | 1-50 字符 | 右列 |
| 邮箱 | Input (disabled) | - | 左列 |
| 手机号 | Input + 国家码下拉 | 可选 | 右列 |
| 个人简介 | Textarea (3 行) | 最长 200 字 | 全宽 |
| 时区 | Select 下拉 | - | 左列 |
| 语言 | Select 下拉 (中文/English) | - | 右列 |

底部: "保存更改" 按钮 (Primary, md, 右对齐)

**保存反馈**: Toast 成功提示 "个人资料已更新"

### 3.3 账户安全

#### 3.3.1 修改密码

- 当前密码输入框
- 新密码输入框 (含强度指示器)
- 确认新密码输入框
- "更新密码" 按钮

#### 3.3.2 两步验证 (2FA)

- 开关: Switch 组件
- 开启流程:
  1. 弹窗显示 QR 码 (200x200px) + 手动输入密钥 (Code 字体, 可复制)
  2. 输入 6 位验证码确认
  3. 显示恢复码 (10 个, 每个 8 字符, 网格布局 2x5)
  4. "我已安全保存恢复码" 确认按钮

#### 3.3.3 活跃会话

- 表格显示当前所有登录会话
- 列: 设备/浏览器 | IP 地址 | 位置 | 最后活跃 | 操作
- 操作: "撤销" 按钮 (Danger Ghost)
- 当前会话标记 "(当前)" Badge

### 3.4 通知偏好

Toggle 开关列表:

| 通知类型 | 邮件 | 站内 | 推送 |
|----------|:----:|:----:|:----:|
| Agent 任务完成 | Toggle | Toggle | Toggle |
| 团队成员变动 | Toggle | Toggle | - |
| 安全告警 | Toggle (锁定开启) | Toggle (锁定开启) | Toggle |
| 产品更新 | Toggle | - | - |
| 用量告警 | Toggle | Toggle | Toggle |

### 3.5 外观设置

- 主题: 三选一 Radio Group (Light / Dark / System)，默认选中 System（跟随操作系统）
- 语言: Select 下拉
- 紧凑模式: Toggle (减少间距 25%)
- 代码字体大小: Slider (12-18px, 步长 1)

### 3.6 API 密钥

- 已创建密钥列表 (表格: 名称 | 前缀 | 创建时间 | 最后使用 | 操作)
- "创建新密钥" 按钮 → Modal:
  - 名称输入框
  - 权限 Scope 多选 (agent:use, session:read, plugin:manage, etc.)
  - 过期时间 Select (30天/90天/1年/永不)
  - 创建后一次性展示完整 Key (Code 字体, 复制按钮, 警告不再显示)
