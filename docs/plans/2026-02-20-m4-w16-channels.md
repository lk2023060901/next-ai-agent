# M4 W16: 渠道管理实现计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标:** 实现完整的渠道管理体验 — 渠道列表（分组显示）、3 步添加向导（选择类型→配置连接→路由设置）、渠道详情页（4 个 Tab：概览/消息日志/路由规则/设置），全部使用 MSW Mock。

**架构:** 两个页面 `ws/[wsSlug]/channels`（列表）和 `ws/[wsSlug]/channels/[channelId]`（详情）。新增 `Channel`、`ChannelMessage`、`RoutingRule` 类型。创建专用 `channel-api.ts`。React Query 钩子在 `use-channels.ts`。五个新特性组件：`channel-card`、`add-channel-wizard`、`channel-overview`、`message-log-table`、`routing-rules-editor`。复用现有 `Card`、`Modal`、`DataTable`、`Tabs`、`Input`、`Select`、`Button`、`Toast`、`EmptyState` UI 原语。所有 MSW 处理器放在 `mocks/handlers/channels.ts`。

**技术栈:** Next.js 15 App Router、TanStack Query v5、MSW v2、Tailwind CSS v4、Lucide icons。无需新包。

---

## 文件映射

```
新建 (8):
  apps/web/lib/api/channel-api.ts                                    # CRUD + 消息 + 路由规则 API
  apps/web/hooks/use-channels.ts                                      # React Query hooks (8 hooks)
  apps/web/mocks/factories/channel.factory.ts                         # Channel + Message + Rule 工厂
  apps/web/mocks/handlers/channels.ts                                 # 所有 MSW 处理器
  apps/web/components/features/channels/channel-card.tsx             # 渠道列表行
  apps/web/components/features/channels/add-channel-wizard.tsx       # 3 步添加向导
  apps/web/components/features/channels/message-log-table.tsx        # 消息日志表格
  apps/web/components/features/channels/routing-rules-editor.tsx     # 路由规则编辑器
  apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/channels/[channelId]/page.tsx  # 详情页

修改 (4):
  apps/web/types/api.ts                                               # 新增 Channel 相关类型
  apps/web/lib/api/index.ts                                           # 导出 channelApi
  apps/web/mocks/handlers/index.ts                                    # 引入 channelHandlers
  apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/channels/page.tsx  # 替换占位页
```

## 依赖关系

```
Task 1 (Types + API)
  ├→ Task 2 (Mocks)           ────────────────────────┐
  ├→ Task 3 (Hooks)           ────────┐                │
  ├→ Task 4 (ChannelCard)     ───┐    ├→ Task 5 (List) │
  └→ Task 6 (Wizard)         ───┘    │                  │
                                      └→ Task 7 (Detail)┘
                                               ↓
                                       Task 8 (Build Verify)
```

执行顺序: 1 → [2, 3, 4, 6] → [5, 7] → 8

---

## Task 1: Types + API Client

**文件:**

- 修改: `apps/web/types/api.ts`
- 新建: `apps/web/lib/api/channel-api.ts`
- 修改: `apps/web/lib/api/index.ts`

### Step 1: 在 `api.ts` 末尾追加类型

```typescript
// ─── Channels ─────────────────────────────────────────────────────────────

export type ChannelType =
  | 'webchat'
  | 'slack'
  | 'discord'
  | 'telegram'
  | 'feishu'
  | 'dingtalk'
  | 'wecom'
  | 'whatsapp'
  | 'signal'
  | 'teams'
  | 'email'

export type ChannelStatus = 'connected' | 'disconnected' | 'error' | 'pending'

export interface Channel {
  id: string
  workspaceId: string
  type: ChannelType
  name: string // e.g. "My Team Slack"
  status: ChannelStatus
  connectedChannels?: number // 已连接子频道数 (Slack/Discord)
  lastActiveAt?: string
  defaultAgentId?: string
  config: Record<string, string> // token / secret 等 (值脱敏显示)
  createdAt: string
  updatedAt: string
  [key: string]: unknown
}

export type MessageDirection = 'inbound' | 'outbound'
export type MessageStatus = 'success' | 'failed'

export interface ChannelMessage {
  id: string
  channelId: string
  direction: MessageDirection
  senderName: string
  content: string
  agentId?: string
  agentName?: string
  status: MessageStatus
  errorDetail?: string
  processingMs?: number
  createdAt: string
  [key: string]: unknown
}

export type RuleField = 'sender' | 'content' | 'group' | 'channel'
export type RuleOperator = 'equals' | 'contains' | 'regex' | 'in_list'

export interface RoutingRule {
  id: string
  channelId: string
  priority: number
  field: RuleField
  operator: RuleOperator
  value: string
  targetAgentId: string
  targetAgentName: string
  enabled: boolean
}

export interface ChannelStats {
  todayInbound: number
  todayOutbound: number
  avgResponseMs: number
  activeUsers: number
  failedMessages: number
  hourlyTrend: Array<{ hour: number; inbound: number; outbound: number }>
}

export interface CreateChannelBody {
  type: ChannelType
  name: string
  config: Record<string, string>
  defaultAgentId?: string
}

export interface UpdateChannelBody {
  name?: string
  config?: Record<string, string>
  defaultAgentId?: string
}

export interface CreateRoutingRuleBody {
  field: RuleField
  operator: RuleOperator
  value: string
  targetAgentId: string
  priority: number
}

export interface ChannelMessageFilters {
  direction?: MessageDirection
  status?: MessageStatus
  sender?: string
  page?: number
  pageSize?: number
}
```

### Step 2: 新建 `apps/web/lib/api/channel-api.ts`

```typescript
import { apiClient } from './client'
import type {
  ApiResponse,
  PaginatedResponse,
  Channel,
  CreateChannelBody,
  UpdateChannelBody,
  ChannelMessage,
  ChannelMessageFilters,
  ChannelStats,
  RoutingRule,
  CreateRoutingRuleBody,
} from '@/types/api'

export const channelApi = {
  // ─── Channels ────────────────────────────────────────────────────────────
  list: (workspaceId: string) =>
    apiClient.get<ApiResponse<Channel[]>>(`/workspaces/${workspaceId}/channels`),

  create: (workspaceId: string, body: CreateChannelBody) =>
    apiClient.post<ApiResponse<Channel>>(`/workspaces/${workspaceId}/channels`, body),

  update: (channelId: string, body: UpdateChannelBody) =>
    apiClient.patch<ApiResponse<Channel>>(`/channels/${channelId}`, body),

  delete: (channelId: string) => apiClient.delete<ApiResponse<null>>(`/channels/${channelId}`),

  testConnection: (channelId: string) =>
    apiClient.post<ApiResponse<{ success: boolean; botName?: string; error?: string }>>(
      `/channels/${channelId}/test`,
      {},
    ),

  // ─── Stats ───────────────────────────────────────────────────────────────
  getStats: (channelId: string) =>
    apiClient.get<ApiResponse<ChannelStats>>(`/channels/${channelId}/stats`),

  // ─── Messages ────────────────────────────────────────────────────────────
  listMessages: (channelId: string, filters: ChannelMessageFilters = {}) => {
    const params = new URLSearchParams()
    if (filters.direction) params.set('direction', filters.direction)
    if (filters.status) params.set('status', filters.status)
    if (filters.sender) params.set('sender', filters.sender)
    if (filters.page) params.set('page', String(filters.page))
    if (filters.pageSize) params.set('pageSize', String(filters.pageSize))
    const qs = params.toString()
    return apiClient.get<PaginatedResponse<ChannelMessage>>(
      `/channels/${channelId}/messages${qs ? `?${qs}` : ''}`,
    )
  },

  // ─── Routing Rules ────────────────────────────────────────────────────────
  listRules: (channelId: string) =>
    apiClient.get<ApiResponse<RoutingRule[]>>(`/channels/${channelId}/rules`),

  createRule: (channelId: string, body: CreateRoutingRuleBody) =>
    apiClient.post<ApiResponse<RoutingRule>>(`/channels/${channelId}/rules`, body),

  updateRule: (
    channelId: string,
    ruleId: string,
    body: Partial<CreateRoutingRuleBody & { enabled: boolean; priority: number }>,
  ) => apiClient.patch<ApiResponse<RoutingRule>>(`/channels/${channelId}/rules/${ruleId}`, body),

  deleteRule: (channelId: string, ruleId: string) =>
    apiClient.delete<ApiResponse<null>>(`/channels/${channelId}/rules/${ruleId}`),
}
```

### Step 3: 更新 `apps/web/lib/api/index.ts`

在末尾追加：

```typescript
export { channelApi } from './channel-api'
```

### Step 4: 验证

```bash
pnpm --filter web typecheck
```

预期：无错误。

---

## Task 2: Mock 工厂 + MSW 处理器

**文件:**

- 新建: `apps/web/mocks/factories/channel.factory.ts`
- 新建: `apps/web/mocks/handlers/channels.ts`
- 修改: `apps/web/mocks/handlers/index.ts`

### Step 1: 新建 `channel.factory.ts`

```typescript
import type {
  Channel,
  ChannelType,
  ChannelStatus,
  ChannelMessage,
  MessageDirection,
  MessageStatus,
  RoutingRule,
  RuleField,
  RuleOperator,
  ChannelStats,
} from '@/types/api'

let channelSeq = 1
let msgSeq = 1
let ruleSeq = 1

function daysAgo(n: number): string {
  const d = new Date()
  d.setDate(d.getDate() - n)
  return d.toISOString()
}

function minutesAgo(n: number): string {
  return new Date(Date.now() - n * 60_000).toISOString()
}

function rand(min: number, max: number): number {
  return Math.floor(Math.random() * (max - min + 1)) + min
}

const CHANNEL_SEEDS: Array<{
  type: ChannelType
  name: string
  status: ChannelStatus
  connectedChannels: number
}> = [
  { type: 'slack', name: 'My Team Slack', status: 'connected', connectedChannels: 3 },
  { type: 'discord', name: 'Community Discord', status: 'connected', connectedChannels: 5 },
  { type: 'telegram', name: 'Support Bot', status: 'connected', connectedChannels: 1 },
  { type: 'webchat', name: 'Website Chat', status: 'connected', connectedChannels: 1 },
  { type: 'feishu', name: '飞书办公', status: 'disconnected', connectedChannels: 0 },
]

export function makeChannel(workspaceId: string, overrides: Partial<Channel> = {}): Channel {
  const seed = CHANNEL_SEEDS[(channelSeq - 1) % CHANNEL_SEEDS.length]!
  return {
    id: `ch-${channelSeq++}`,
    workspaceId,
    type: seed.type,
    name: seed.name,
    status: seed.status,
    connectedChannels: seed.connectedChannels,
    lastActiveAt: minutesAgo(rand(1, 120)),
    defaultAgentId: 'agent-1',
    config: {},
    createdAt: daysAgo(rand(10, 60)),
    updatedAt: daysAgo(rand(0, 5)),
    ...overrides,
  }
}

export function makeChannelList(workspaceId: string): Channel[] {
  return CHANNEL_SEEDS.map((seed) => makeChannel(workspaceId, { ...seed }))
}

const SENDERS = ['Alice', 'Bob', 'Charlie', 'David', 'Eva', 'Frank', 'Grace']
const MSG_CONTENTS = [
  '你好，我想了解一下产品功能',
  '如何配置 API 密钥？',
  '我遇到了一个 Bug，应用无法启动',
  '能帮我分析这段代码吗？',
  '你好！有什么可以帮助你的？',
  '根据您的描述，这个问题可以通过以下步骤解决...',
  '请稍等，我正在查询相关文档...',
  '已为您找到解决方案，请参考以下步骤',
]

export function makeChannelMessage(
  channelId: string,
  overrides: Partial<ChannelMessage> = {},
): ChannelMessage {
  const direction: MessageDirection = Math.random() > 0.5 ? 'inbound' : 'outbound'
  const status: MessageStatus = Math.random() > 0.1 ? 'success' : 'failed'
  return {
    id: `msg-${msgSeq++}`,
    channelId,
    direction,
    senderName: direction === 'inbound' ? SENDERS[rand(0, SENDERS.length - 1)]! : 'AI Agent',
    content: MSG_CONTENTS[rand(0, MSG_CONTENTS.length - 1)]!,
    agentId: direction === 'outbound' ? 'agent-1' : undefined,
    agentName: direction === 'outbound' ? '协调 Agent' : undefined,
    status,
    ...(status === 'failed' ? { errorDetail: 'Network timeout' } : {}),
    processingMs: rand(50, 2000),
    createdAt: minutesAgo(rand(1, 1440)),
    ...overrides,
  }
}

export function makeChannelMessageList(channelId: string, count = 50): ChannelMessage[] {
  return Array.from({ length: count }, () => makeChannelMessage(channelId)).sort(
    (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(),
  )
}

const RULE_SEEDS: Array<{
  field: RuleField
  operator: RuleOperator
  value: string
  targetAgentName: string
}> = [
  { field: 'sender', operator: 'contains', value: '@admin', targetAgentName: '协调 Agent' },
  { field: 'content', operator: 'contains', value: '/bug', targetAgentName: '测试 Agent' },
  {
    field: 'content',
    operator: 'regex',
    value: '.*帮助.*|.*help.*',
    targetAgentName: '客服 Agent',
  },
]

export function makeRoutingRule(
  channelId: string,
  overrides: Partial<RoutingRule> = {},
): RoutingRule {
  const seed = RULE_SEEDS[(ruleSeq - 1) % RULE_SEEDS.length]!
  return {
    id: `rule-${ruleSeq++}`,
    channelId,
    priority: ruleSeq,
    field: seed.field,
    operator: seed.operator,
    value: seed.value,
    targetAgentId: `agent-${rand(1, 3)}`,
    targetAgentName: seed.targetAgentName,
    enabled: true,
    ...overrides,
  }
}

export function makeRoutingRuleList(channelId: string): RoutingRule[] {
  return RULE_SEEDS.map((seed) => makeRoutingRule(channelId, { ...seed }))
}

export function makeChannelStats(): ChannelStats {
  return {
    todayInbound: rand(50, 500),
    todayOutbound: rand(40, 480),
    avgResponseMs: rand(200, 1500),
    activeUsers: rand(5, 50),
    failedMessages: rand(0, 10),
    hourlyTrend: Array.from({ length: 24 }, (_, hour) => ({
      hour,
      inbound: rand(0, 30),
      outbound: rand(0, 25),
    })),
  }
}
```

### Step 2: 新建 `mocks/handlers/channels.ts`

```typescript
import { http, HttpResponse, delay } from 'msw'
import {
  makeChannelList,
  makeChannel,
  makeChannelMessageList,
  makeChannelMessage,
  makeRoutingRuleList,
  makeRoutingRule,
  makeChannelStats,
} from '../factories/channel.factory'
import type { Channel, ChannelMessage, RoutingRule } from '@/types/api'

// In-memory stores
const CHANNEL_STORE: Record<string, Channel[]> = {}
const MESSAGE_STORE: Record<string, ChannelMessage[]> = {}
const RULE_STORE: Record<string, RoutingRule[]> = {}

function getChannels(wsId: string): Channel[] {
  if (!CHANNEL_STORE[wsId]) CHANNEL_STORE[wsId] = makeChannelList(wsId)
  return CHANNEL_STORE[wsId]!
}

function getMessages(channelId: string): ChannelMessage[] {
  if (!MESSAGE_STORE[channelId]) MESSAGE_STORE[channelId] = makeChannelMessageList(channelId)
  return MESSAGE_STORE[channelId]!
}

function getRules(channelId: string): RoutingRule[] {
  if (!RULE_STORE[channelId]) RULE_STORE[channelId] = makeRoutingRuleList(channelId)
  return RULE_STORE[channelId]!
}

export const channelHandlers = [
  // ─── Channels ─────────────────────────────────────────────────────────────

  http.get('/api/workspaces/:wsId/channels', async ({ params }) => {
    await delay(200)
    return HttpResponse.json({ data: getChannels(params.wsId as string) })
  }),

  http.post('/api/workspaces/:wsId/channels', async ({ params, request }) => {
    await delay(400)
    const body = (await request.json()) as {
      type: string
      name: string
      config: Record<string, string>
      defaultAgentId?: string
    }
    const wsId = params.wsId as string
    const channel = makeChannel(wsId, {
      type: body.type as Channel['type'],
      name: body.name,
      config: body.config,
      status: 'connected',
      connectedChannels: 1,
      ...(body.defaultAgentId ? { defaultAgentId: body.defaultAgentId } : {}),
    })
    getChannels(wsId).unshift(channel)
    return HttpResponse.json({ data: channel }, { status: 201 })
  }),

  http.patch('/api/channels/:channelId', async ({ params, request }) => {
    await delay(300)
    const body = (await request.json()) as Partial<Channel>
    const channelId = params.channelId as string
    let updated: Channel | undefined
    for (const wsId of Object.keys(CHANNEL_STORE)) {
      const arr = CHANNEL_STORE[wsId]!
      const idx = arr.findIndex((c) => c.id === channelId)
      if (idx !== -1) {
        arr[idx] = { ...arr[idx]!, ...body, updatedAt: new Date().toISOString() }
        updated = arr[idx]
        break
      }
    }
    if (!updated) return HttpResponse.json({ message: 'Not found' }, { status: 404 })
    return HttpResponse.json({ data: updated })
  }),

  http.delete('/api/channels/:channelId', async ({ params }) => {
    await delay(300)
    const channelId = params.channelId as string
    for (const wsId of Object.keys(CHANNEL_STORE)) {
      const arr = CHANNEL_STORE[wsId]!
      const idx = arr.findIndex((c) => c.id === channelId)
      if (idx !== -1) {
        arr.splice(idx, 1)
        delete MESSAGE_STORE[channelId]
        delete RULE_STORE[channelId]
        break
      }
    }
    return HttpResponse.json({ data: null })
  }),

  // ─── Test Connection ───────────────────────────────────────────────────────

  http.post('/api/channels/:channelId/test', async () => {
    await delay(800) // simulate network round-trip
    // 90% success rate in mock
    const success = Math.random() > 0.1
    return HttpResponse.json({
      data: success
        ? { success: true, botName: 'NextAI Bot' }
        : { success: false, error: 'Invalid token or network error' },
    })
  }),

  // ─── Stats ────────────────────────────────────────────────────────────────

  http.get('/api/channels/:channelId/stats', async () => {
    await delay(250)
    return HttpResponse.json({ data: makeChannelStats() })
  }),

  // ─── Messages ─────────────────────────────────────────────────────────────

  http.get('/api/channels/:channelId/messages', async ({ params, request }) => {
    await delay(300)
    const channelId = params.channelId as string
    const url = new URL(request.url)
    const direction = url.searchParams.get('direction')
    const status = url.searchParams.get('status')
    const sender = url.searchParams.get('sender')
    const page = Number(url.searchParams.get('page') ?? 1)
    const pageSize = Number(url.searchParams.get('pageSize') ?? 50)

    let msgs = getMessages(channelId)
    if (direction) msgs = msgs.filter((m) => m.direction === direction)
    if (status) msgs = msgs.filter((m) => m.status === status)
    if (sender) msgs = msgs.filter((m) => m.senderName.toLowerCase().includes(sender.toLowerCase()))

    const total = msgs.length
    const slice = msgs.slice((page - 1) * pageSize, page * pageSize)
    return HttpResponse.json({
      data: slice,
      total,
      page,
      pageSize,
      totalPages: Math.ceil(total / pageSize),
    })
  }),

  // ─── Routing Rules ─────────────────────────────────────────────────────────

  http.get('/api/channels/:channelId/rules', async ({ params }) => {
    await delay(200)
    const rules = getRules(params.channelId as string)
    return HttpResponse.json({ data: rules })
  }),

  http.post('/api/channels/:channelId/rules', async ({ params, request }) => {
    await delay(300)
    const body = (await request.json()) as {
      field: string
      operator: string
      value: string
      targetAgentId: string
      priority: number
    }
    const channelId = params.channelId as string
    const rule = makeRoutingRule(channelId, {
      field: body.field as RoutingRule['field'],
      operator: body.operator as RoutingRule['operator'],
      value: body.value,
      targetAgentId: body.targetAgentId,
      priority: body.priority,
    })
    getRules(channelId).push(rule)
    getRules(channelId).sort((a, b) => a.priority - b.priority)
    return HttpResponse.json({ data: rule }, { status: 201 })
  }),

  http.patch('/api/channels/:channelId/rules/:ruleId', async ({ params, request }) => {
    await delay(200)
    const body = (await request.json()) as Partial<RoutingRule>
    const { channelId, ruleId } = params as { channelId: string; ruleId: string }
    const arr = getRules(channelId)
    const idx = arr.findIndex((r) => r.id === ruleId)
    if (idx === -1) return HttpResponse.json({ message: 'Not found' }, { status: 404 })
    arr[idx] = { ...arr[idx]!, ...body }
    return HttpResponse.json({ data: arr[idx] })
  }),

  http.delete('/api/channels/:channelId/rules/:ruleId', async ({ params }) => {
    await delay(200)
    const { channelId, ruleId } = params as { channelId: string; ruleId: string }
    const arr = getRules(channelId)
    const idx = arr.findIndex((r) => r.id === ruleId)
    if (idx !== -1) arr.splice(idx, 1)
    return HttpResponse.json({ data: null })
  }),
]
```

### Step 3: 更新 `mocks/handlers/index.ts`

在已有 import 后添加：

```typescript
import { channelHandlers } from './channels'
```

在 handlers 数组中展开：

```typescript
...channelHandlers,
```

### Step 4: 验证

```bash
pnpm --filter web typecheck
```

---

## Task 3: React Query Hooks

**文件:** 新建 `apps/web/hooks/use-channels.ts`

```typescript
'use client'

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { channelApi } from '@/lib/api/channel-api'
import type {
  CreateChannelBody,
  UpdateChannelBody,
  Channel,
  ChannelMessageFilters,
  CreateRoutingRuleBody,
  RoutingRule,
} from '@/types/api'

// ─── Channels ────────────────────────────────────────────────────────────────

export function useChannels(workspaceId: string) {
  return useQuery({
    queryKey: ['channels', workspaceId],
    queryFn: () => channelApi.list(workspaceId).then((r) => r.data),
    enabled: !!workspaceId,
    staleTime: 30_000,
  })
}

export function useCreateChannel(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (body: CreateChannelBody) =>
      channelApi.create(workspaceId, body).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['channels', workspaceId] })
    },
  })
}

export function useUpdateChannel(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ id, body }: { id: string; body: UpdateChannelBody }) =>
      channelApi.update(id, body).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['channels', workspaceId] })
    },
  })
}

export function useDeleteChannel(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (channelId: string) => channelApi.delete(channelId),
    onMutate: async (channelId) => {
      await qc.cancelQueries({ queryKey: ['channels', workspaceId] })
      const previous = qc.getQueryData<Channel[]>(['channels', workspaceId])
      qc.setQueryData<Channel[]>(['channels', workspaceId], (old) =>
        old ? old.filter((c) => c.id !== channelId) : [],
      )
      return { previous }
    },
    onError: (_err, _id, ctx) => {
      if (ctx?.previous) qc.setQueryData(['channels', workspaceId], ctx.previous)
    },
    onSettled: () => {
      void qc.invalidateQueries({ queryKey: ['channels', workspaceId] })
    },
  })
}

export function useTestConnection(channelId: string) {
  return useMutation({
    mutationFn: () => channelApi.testConnection(channelId).then((r) => r.data),
  })
}

// ─── Stats ────────────────────────────────────────────────────────────────────

export function useChannelStats(channelId: string) {
  return useQuery({
    queryKey: ['channel-stats', channelId],
    queryFn: () => channelApi.getStats(channelId).then((r) => r.data),
    enabled: !!channelId,
    staleTime: 60_000,
  })
}

// ─── Messages ─────────────────────────────────────────────────────────────────

export function useChannelMessages(channelId: string, filters: ChannelMessageFilters = {}) {
  return useQuery({
    queryKey: ['channel-messages', channelId, filters],
    queryFn: () => channelApi.listMessages(channelId, filters),
    enabled: !!channelId,
    staleTime: 30_000,
  })
}

// ─── Routing Rules ────────────────────────────────────────────────────────────

export function useRoutingRules(channelId: string) {
  return useQuery({
    queryKey: ['channel-rules', channelId],
    queryFn: () => channelApi.listRules(channelId).then((r) => r.data),
    enabled: !!channelId,
    staleTime: 30_000,
  })
}

export function useCreateRoutingRule(channelId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (body: CreateRoutingRuleBody) =>
      channelApi.createRule(channelId, body).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['channel-rules', channelId] })
    },
  })
}

export function useUpdateRoutingRule(channelId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ ruleId, body }: { ruleId: string; body: Partial<RoutingRule> }) =>
      channelApi.updateRule(channelId, ruleId, body).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['channel-rules', channelId] })
    },
  })
}

export function useDeleteRoutingRule(channelId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (ruleId: string) => channelApi.deleteRule(channelId, ruleId),
    onMutate: async (ruleId) => {
      await qc.cancelQueries({ queryKey: ['channel-rules', channelId] })
      const previous = qc.getQueryData<RoutingRule[]>(['channel-rules', channelId])
      qc.setQueryData<RoutingRule[]>(['channel-rules', channelId], (old) =>
        old ? old.filter((r) => r.id !== ruleId) : [],
      )
      return { previous }
    },
    onError: (_err, _id, ctx) => {
      if (ctx?.previous) qc.setQueryData(['channel-rules', channelId], ctx.previous)
    },
    onSettled: () => {
      void qc.invalidateQueries({ queryKey: ['channel-rules', channelId] })
    },
  })
}
```

### 验证

```bash
pnpm --filter web typecheck
```

---

## Task 4: ChannelCard 组件

**文件:** 新建 `apps/web/components/features/channels/channel-card.tsx`

```typescript
'use client'

import { useState, useRef, useEffect } from 'react'
import {
  MessageCircle, Hash, Send, Mail, MoreHorizontal, Settings, Unplug,
  CheckCircle, XCircle, AlertCircle, Clock,
} from 'lucide-react'
import { cn } from '@/lib/utils/cn'
import type { Channel, ChannelType, ChannelStatus } from '@/types/api'

interface ChannelCardProps {
  channel: Channel
  onConfigure?: (channel: Channel) => void
  onDisconnect?: (channel: Channel) => void
  onClick?: (channel: Channel) => void
}

// 渠道图标映射 (使用 Lucide 近似图标)
const CHANNEL_ICONS: Record<ChannelType, React.ElementType> = {
  webchat: MessageCircle,
  slack: Hash,
  discord: Hash,
  telegram: Send,
  feishu: MessageCircle,
  dingtalk: MessageCircle,
  wecom: MessageCircle,
  whatsapp: MessageCircle,
  signal: MessageCircle,
  teams: Hash,
  email: Mail,
}

// 渠道名称颜色
const CHANNEL_COLORS: Record<ChannelType, string> = {
  slack: 'bg-[#4A154B] text-white',
  discord: 'bg-[#5865F2] text-white',
  telegram: 'bg-[#229ED9] text-white',
  webchat: 'bg-[var(--color-primary-500)] text-white',
  feishu: 'bg-[#3370FF] text-white',
  dingtalk: 'bg-[#1677FF] text-white',
  wecom: 'bg-[#07C160] text-white',
  whatsapp: 'bg-[#25D366] text-white',
  signal: 'bg-[#3A76F0] text-white',
  teams: 'bg-[#6264A7] text-white',
  email: 'bg-[var(--text-secondary)] text-white',
}

const CHANNEL_LABELS: Record<ChannelType, string> = {
  webchat: 'WebChat',
  slack: 'Slack',
  discord: 'Discord',
  telegram: 'Telegram',
  feishu: '飞书',
  dingtalk: '钉钉',
  wecom: '企业微信',
  whatsapp: 'WhatsApp',
  signal: 'Signal',
  teams: 'Microsoft Teams',
  email: 'Email',
}

const STATUS_CONFIG: Record<ChannelStatus, { label: string; icon: React.ElementType; className: string }> = {
  connected: { label: '在线', icon: CheckCircle, className: 'text-[var(--color-success)]' },
  disconnected: { label: '已断开', icon: XCircle, className: 'text-[var(--text-tertiary)]' },
  error: { label: '错误', icon: AlertCircle, className: 'text-[var(--color-danger)]' },
  pending: { label: '连接中', icon: Clock, className: 'text-[var(--color-warning)]' },
}

function timeAgo(iso: string): string {
  const ms = Date.now() - new Date(iso).getTime()
  const mins = Math.floor(ms / 60_000)
  if (mins < 1) return '刚刚'
  if (mins < 60) return `${mins} 分钟前`
  const hours = Math.floor(mins / 60)
  if (hours < 24) return `${hours} 小时前`
  return `${Math.floor(hours / 24)} 天前`
}

export function ChannelCard({ channel, onConfigure, onDisconnect, onClick }: ChannelCardProps) {
  const [menuOpen, setMenuOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)
  const Icon = CHANNEL_ICONS[channel.type]
  const statusCfg = STATUS_CONFIG[channel.status]
  const StatusIcon = statusCfg.icon

  useEffect(() => {
    function handler(e: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) setMenuOpen(false)
    }
    document.addEventListener('mousedown', handler)
    return () => document.removeEventListener('mousedown', handler)
  }, [])

  return (
    <div
      className={cn(
        'group flex items-center gap-4 rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--bg)] p-4',
        'transition-colors duration-[var(--duration-fast)] hover:border-[var(--color-primary-200)]',
        onClick && 'cursor-pointer',
      )}
      onClick={onClick ? () => onClick(channel) : undefined}
    >
      {/* Icon */}
      <div className={cn('flex h-10 w-10 shrink-0 items-center justify-center rounded-[var(--radius-md)]', CHANNEL_COLORS[channel.type])}>
        <Icon className="h-5 w-5" />
      </div>

      {/* Info */}
      <div className="min-w-0 flex-1">
        <div className="flex items-center gap-2">
          <span className="text-sm font-semibold text-[var(--text-primary)]">{channel.name}</span>
          <span className={cn('flex items-center gap-1 text-xs', statusCfg.className)}>
            <StatusIcon className="h-3.5 w-3.5" />
            {statusCfg.label}
          </span>
        </div>
        <p className="mt-0.5 text-xs text-[var(--text-secondary)]">{CHANNEL_LABELS[channel.type]}</p>
        <p className="mt-0.5 text-xs text-[var(--text-tertiary)]">
          {channel.connectedChannels
            ? `已连接 ${channel.connectedChannels} 个频道`
            : '未连接频道'}
          {channel.lastActiveAt && ` · 最近活跃: ${timeAgo(channel.lastActiveAt)}`}
        </p>
      </div>

      {/* Actions */}
      {(onConfigure || onDisconnect) && (
        <div ref={menuRef} className="relative shrink-0" onClick={(e) => e.stopPropagation()}>
          <button
            onClick={() => setMenuOpen((v) => !v)}
            className="rounded-[var(--radius-sm)] p-1 text-[var(--text-tertiary)] opacity-0 transition-opacity group-hover:opacity-100 hover:bg-[var(--surface-2)] hover:text-[var(--text-primary)]"
          >
            <MoreHorizontal className="h-4 w-4" />
          </button>
          {menuOpen && (
            <div
              role="menu"
              className="absolute right-0 top-full z-20 mt-1 w-32 rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--bg)] py-1 shadow-lg"
            >
              {onConfigure && (
                <button
                  role="menuitem"
                  onClick={() => { setMenuOpen(false); onConfigure(channel) }}
                  className="flex w-full items-center gap-2 px-3 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--surface)]"
                >
                  <Settings className="h-3.5 w-3.5" />
                  配置
                </button>
              )}
              {onDisconnect && (
                <button
                  role="menuitem"
                  onClick={() => { setMenuOpen(false); onDisconnect(channel) }}
                  className="flex w-full items-center gap-2 px-3 py-2 text-sm text-[var(--color-danger)] hover:bg-[var(--surface)]"
                >
                  <Unplug className="h-3.5 w-3.5" />
                  断开
                </button>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  )
}
```

### 验证

```bash
pnpm --filter web typecheck
```

---

## Task 5: 渠道列表页

**文件:** 修改 `apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/channels/page.tsx`

完整替换为：

```typescript
'use client'

import { useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { Plus, Radio } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Modal } from '@/components/ui/modal'
import { EmptyState } from '@/components/ui/empty-state'
import { ChannelCard } from '@/components/features/channels/channel-card'
import { AddChannelWizard } from '@/components/features/channels/add-channel-wizard'
import { toast } from '@/components/ui/toast'
import {
  useChannels,
  useCreateChannel,
  useDeleteChannel,
} from '@/hooks/use-channels'
import type { Channel, CreateChannelBody } from '@/types/api'

export default function ChannelsPage() {
  const { wsSlug, slug } = useParams<{ wsSlug: string; slug: string }>()
  const router = useRouter()

  const { data: channels, isLoading } = useChannels(wsSlug)
  const createChannel = useCreateChannel(wsSlug)
  const deleteChannel = useDeleteChannel(wsSlug)

  const [wizardOpen, setWizardOpen] = useState(false)
  const [disconnectingChannel, setDisconnectingChannel] = useState<Channel | null>(null)

  async function handleCreate(body: CreateChannelBody) {
    try {
      await createChannel.mutateAsync(body)
      toast.success('渠道已添加')
      setWizardOpen(false)
    } catch {
      toast.error('添加失败，请重试')
    }
  }

  async function handleDisconnectConfirm() {
    if (!disconnectingChannel) return
    try {
      await deleteChannel.mutateAsync(disconnectingChannel.id)
      toast.success('渠道已断开')
      setDisconnectingChannel(null)
    } catch {
      toast.error('操作失败，请重试')
    }
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-xl font-semibold text-[var(--text-primary)]">渠道管理</h1>
          <p className="mt-1 text-sm text-[var(--text-secondary)]">连接消息渠道，让 Agent 接收和发送消息</p>
        </div>
        <Button onClick={() => setWizardOpen(true)}>
          <Plus className="mr-1.5 h-4 w-4" />
          添加渠道
        </Button>
      </div>

      {/* Content */}
      {isLoading ? (
        <div className="space-y-3">
          {Array.from({ length: 3 }, (_, i) => (
            <div key={i} className="h-20 animate-pulse rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--surface)]" />
          ))}
        </div>
      ) : !channels || channels.length === 0 ? (
        <EmptyState
          icon={<Radio className="h-6 w-6" />}
          title="还没有渠道"
          description="添加渠道，让 Agent 通过 Slack、Discord、Telegram 等平台与用户交互"
          action={
            <Button size="sm" onClick={() => setWizardOpen(true)}>
              <Plus className="mr-1 h-3.5 w-3.5" />
              添加渠道
            </Button>
          }
        />
      ) : (
        <div className="space-y-3">
          {channels.map((channel) => (
            <ChannelCard
              key={channel.id}
              channel={channel}
              onConfigure={(c) => router.push(`/org/${slug}/ws/${wsSlug}/channels/${c.id}`)}
              onDisconnect={(c) => setDisconnectingChannel(c)}
              onClick={(c) => router.push(`/org/${slug}/ws/${wsSlug}/channels/${c.id}`)}
            />
          ))}
        </div>
      )}

      {/* Add Channel Wizard */}
      <AddChannelWizard
        open={wizardOpen}
        onClose={() => setWizardOpen(false)}
        onSubmit={handleCreate}
        loading={createChannel.isPending}
        workspaceId={wsSlug}
      />

      {/* Disconnect Confirm */}
      <Modal
        open={!!disconnectingChannel}
        onClose={() => setDisconnectingChannel(null)}
        title="断开渠道"
        size="sm"
        footer={
          <div className="flex justify-end gap-2">
            <Button variant="ghost" onClick={() => setDisconnectingChannel(null)}>取消</Button>
            <Button variant="danger" onClick={handleDisconnectConfirm} {...(deleteChannel.isPending ? { loading: true } : {})}>
              断开
            </Button>
          </div>
        }
      >
        <p className="text-sm text-[var(--text-secondary)]">
          确定要断开渠道 <strong>{disconnectingChannel?.name}</strong> 吗？所有路由规则将被删除，此操作不可撤销。
        </p>
      </Modal>
    </div>
  )
}
```

### 验证

```bash
pnpm --filter web typecheck
```

---

## Task 6: AddChannelWizard 组件

**文件:** 新建 `apps/web/components/features/channels/add-channel-wizard.tsx`

这是最复杂的组件，实现 3 步向导：选择渠道类型 → 配置连接 → 路由设置。

```typescript
'use client'

import { useState } from 'react'
import { CheckCircle, ExternalLink, Copy, Check, Loader2 } from 'lucide-react'
import { Modal } from '@/components/ui/modal'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Select } from '@/components/ui/select'
import { cn } from '@/lib/utils/cn'
import { useTestConnection } from '@/hooks/use-channels'
import type { ChannelType, CreateChannelBody } from '@/types/api'

// ─── 渠道元数据 ──────────────────────────────────────────────────────────────

interface ChannelMeta {
  type: ChannelType
  label: string
  description: string
  color: string
  available: boolean
  fields: Array<{ key: string; label: string; placeholder: string; secret?: boolean; readonly?: boolean }>
}

const CHANNEL_META: ChannelMeta[] = [
  {
    type: 'webchat',
    label: 'WebChat',
    description: '网站内嵌聊天组件',
    color: 'bg-[var(--color-primary-500)]',
    available: true,
    fields: [],
  },
  {
    type: 'slack',
    label: 'Slack',
    description: '团队协作工具',
    color: 'bg-[#4A154B]',
    available: true,
    fields: [
      { key: 'botToken', label: 'Bot Token', placeholder: 'xoxb-...' },
      { key: 'appToken', label: 'App Token', placeholder: 'xapp-...' },
      { key: 'signingSecret', label: 'Signing Secret', placeholder: '签名密钥', secret: true },
    ],
  },
  {
    type: 'discord',
    label: 'Discord',
    description: '游戏与社区平台',
    color: 'bg-[#5865F2]',
    available: true,
    fields: [
      { key: 'botToken', label: 'Bot Token', placeholder: '机器人 Token' },
      { key: 'applicationId', label: 'Application ID', placeholder: '应用 ID' },
    ],
  },
  {
    type: 'telegram',
    label: 'Telegram',
    description: '即时通讯工具',
    color: 'bg-[#229ED9]',
    available: true,
    fields: [
      { key: 'botToken', label: 'Bot Token', placeholder: '123456:ABC-DEF...' },
      { key: 'webhookUrl', label: 'Webhook URL', placeholder: '自动生成', readonly: true },
    ],
  },
  {
    type: 'feishu',
    label: '飞书',
    description: '字节跳动企业协作',
    color: 'bg-[#3370FF]',
    available: true,
    fields: [
      { key: 'appId', label: 'App ID', placeholder: 'cli_...' },
      { key: 'appSecret', label: 'App Secret', placeholder: 'App Secret', secret: true },
      { key: 'verificationToken', label: 'Verification Token', placeholder: '验证令牌' },
    ],
  },
  {
    type: 'dingtalk',
    label: '钉钉',
    description: '阿里巴巴企业协作',
    color: 'bg-[#1677FF]',
    available: false,
    fields: [],
  },
  {
    type: 'wecom',
    label: '企业微信',
    description: '腾讯企业协作工具',
    color: 'bg-[#07C160]',
    available: false,
    fields: [],
  },
  {
    type: 'whatsapp',
    label: 'WhatsApp',
    description: 'Meta 即时通讯',
    color: 'bg-[#25D366]',
    available: false,
    fields: [],
  },
  {
    type: 'teams',
    label: 'Microsoft Teams',
    description: '微软企业协作',
    color: 'bg-[#6264A7]',
    available: false,
    fields: [],
  },
  {
    type: 'email',
    label: 'Email',
    description: 'IMAP/SMTP 邮件',
    color: 'bg-[var(--text-secondary)]',
    available: false,
    fields: [],
  },
]

const DM_OPTIONS = [
  { value: 'paired', label: '配对模式（推荐）' },
  { value: 'open', label: '开放模式' },
  { value: 'allowlist', label: '仅允许列表' },
]

const GROUP_OPTIONS = [
  { value: 'mention', label: '提及触发（推荐）' },
  { value: 'always', label: '始终响应' },
  { value: 'keyword', label: '关键词触发' },
]

// ─── 步骤指示器 ──────────────────────────────────────────────────────────────

function StepIndicator({ step }: { step: 1 | 2 | 3 }) {
  const steps = ['选择渠道', '配置连接', '路由设置']
  return (
    <div className="flex items-center justify-center gap-0 mb-6">
      {steps.map((label, idx) => {
        const num = idx + 1
        const done = step > num
        const active = step === num
        return (
          <div key={num} className="flex items-center">
            <div className="flex flex-col items-center gap-1">
              <div
                className={cn(
                  'flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold',
                  done && 'bg-[var(--color-success)] text-white',
                  active && 'bg-[var(--color-primary-500)] text-white',
                  !done && !active && 'bg-[var(--surface-2)] text-[var(--text-tertiary)]',
                )}
              >
                {done ? <CheckCircle className="h-4 w-4" /> : num}
              </div>
              <span
                className={cn(
                  'text-[11px] whitespace-nowrap',
                  active && 'font-semibold text-[var(--color-primary-500)]',
                  done && 'text-[var(--color-success)]',
                  !done && !active && 'text-[var(--text-tertiary)]',
                )}
              >
                {label}
              </span>
            </div>
            {idx < steps.length - 1 && (
              <div
                className={cn(
                  'mx-2 mb-4 h-0.5 w-16',
                  step > num + 1 ? 'bg-[var(--color-success)]' : step > num ? 'bg-[var(--color-primary-500)]' : 'bg-[var(--border)]',
                )}
              />
            )}
          </div>
        )
      })}
    </div>
  )
}

// ─── 主组件 ──────────────────────────────────────────────────────────────────

interface AddChannelWizardProps {
  open: boolean
  onClose: () => void
  onSubmit: (body: CreateChannelBody) => void
  loading?: boolean
  workspaceId: string
}

export function AddChannelWizard({ open, onClose, onSubmit, loading = false }: AddChannelWizardProps) {
  const [step, setStep] = useState<1 | 2 | 3>(1)
  const [selectedType, setSelectedType] = useState<ChannelType | null>(null)
  const [config, setConfig] = useState<Record<string, string>>({})
  const [channelName, setChannelName] = useState('')
  const [dmPolicy, setDmPolicy] = useState('paired')
  const [groupPolicy, setGroupPolicy] = useState('mention')
  const [defaultAgentId] = useState('agent-1')
  const [testResult, setTestResult] = useState<{ success: boolean; botName?: string; error?: string } | null>(null)
  const [copied, setCopied] = useState(false)

  const testConn = useTestConnection('preview')

  const selectedMeta = CHANNEL_META.find((m) => m.type === selectedType)

  function handleClose() {
    setStep(1)
    setSelectedType(null)
    setConfig({})
    setChannelName('')
    setTestResult(null)
    onClose()
  }

  function handleSelectType(type: ChannelType) {
    const meta = CHANNEL_META.find((m) => m.type === type)
    if (!meta?.available) return
    setSelectedType(type)
    setChannelName(`My ${CHANNEL_META.find((m) => m.type === type)?.label ?? ''} Channel`)
    setConfig({})
    setTestResult(null)
  }

  function handleNext() {
    if (step === 1 && selectedType) setStep(2)
    else if (step === 2) setStep(3)
  }

  async function handleTest() {
    const result = await testConn.mutateAsync()
    setTestResult(result)
  }

  function handleCopyWebhook() {
    void navigator.clipboard.writeText('https://app.nextai-agent.com/webhooks/telegram/xxx')
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  function handleSubmit() {
    if (!selectedType) return
    onSubmit({
      type: selectedType,
      name: channelName,
      config,
      defaultAgentId,
    })
  }

  const canProceedStep1 = !!selectedType
  const canProceedStep2 = selectedMeta?.fields.every((f) => f.readonly || !!config[f.key]) ?? true

  return (
    <Modal
      open={open}
      onClose={handleClose}
      title="添加渠道"
      size="lg"
      footer={
        <div className="flex justify-between">
          <Button variant="ghost" onClick={step === 1 ? handleClose : () => setStep((s) => (s - 1) as 1 | 2 | 3)}>
            {step === 1 ? '取消' : '上一步'}
          </Button>
          <div className="flex gap-2">
            {step < 3 ? (
              <Button
                onClick={handleNext}
                disabled={step === 1 ? !canProceedStep1 : !canProceedStep2}
              >
                下一步
              </Button>
            ) : (
              <Button onClick={handleSubmit} {...(loading ? { loading: true } : {})}>
                完成
              </Button>
            )}
          </div>
        </div>
      }
    >
      <StepIndicator step={step} />

      {/* Step 1: 选择渠道类型 */}
      {step === 1 && (
        <div className="grid grid-cols-3 gap-3">
          {CHANNEL_META.map((meta) => (
            <button
              key={meta.type}
              disabled={!meta.available}
              onClick={() => handleSelectType(meta.type)}
              className={cn(
                'relative flex flex-col items-center gap-2 rounded-[var(--radius-md)] border p-4 text-center transition-colors',
                !meta.available && 'cursor-not-allowed opacity-40',
                meta.available && selectedType === meta.type
                  ? 'border-2 border-[var(--color-primary-500)] bg-[var(--color-primary-50)]'
                  : meta.available
                    ? 'border-[var(--border)] hover:border-[var(--color-primary-300)]'
                    : 'border-[var(--border)]',
              )}
            >
              <div className={cn('flex h-12 w-12 items-center justify-center rounded-[var(--radius-md)] text-white text-xs font-bold', meta.color)}>
                {meta.label.slice(0, 2)}
              </div>
              <div>
                <p className="text-sm font-semibold text-[var(--text-primary)]">{meta.label}</p>
                <p className="text-[11px] text-[var(--text-tertiary)]">{meta.description}</p>
              </div>
              {!meta.available && (
                <span className="absolute right-2 top-2 rounded-full bg-[var(--surface-2)] px-1.5 py-0.5 text-[10px] text-[var(--text-tertiary)]">
                  即将推出
                </span>
              )}
              {selectedType === meta.type && (
                <CheckCircle className="absolute right-2 top-2 h-4 w-4 text-[var(--color-primary-500)]" />
              )}
            </button>
          ))}
        </div>
      )}

      {/* Step 2: 配置连接 */}
      {step === 2 && selectedMeta && (
        <div className="space-y-4">
          <Input
            label="渠道名称"
            value={channelName}
            onChange={(e) => setChannelName(e.target.value)}
            fullWidth
          />

          {selectedMeta.type === 'webchat' ? (
            <div className="rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--surface)] p-4">
              <p className="text-sm text-[var(--text-secondary)]">
                WebChat 无需额外配置，创建后即可获得嵌入代码。
              </p>
            </div>
          ) : (
            <>
              {selectedMeta.fields.map((field) => (
                <div key={field.key} className="relative">
                  {field.readonly ? (
                    <div>
                      <label className="mb-1.5 block text-sm font-medium text-[var(--text-primary)]">
                        {field.label}
                      </label>
                      <div className="flex items-center gap-2 rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--surface)] px-3 py-2">
                        <span className="flex-1 truncate font-mono text-xs text-[var(--text-secondary)]">
                          https://app.nextai-agent.com/webhooks/{selectedMeta.type}/xxx
                        </span>
                        <button onClick={handleCopyWebhook} className="text-[var(--text-tertiary)] hover:text-[var(--text-primary)]">
                          {copied ? <Check className="h-4 w-4 text-[var(--color-success)]" /> : <Copy className="h-4 w-4" />}
                        </button>
                      </div>
                    </div>
                  ) : (
                    <Input
                      label={field.label}
                      placeholder={field.placeholder}
                      type={field.secret ? 'password' : 'text'}
                      value={config[field.key] ?? ''}
                      onChange={(e) => setConfig((c) => ({ ...c, [field.key]: e.target.value }))}
                      fullWidth
                    />
                  )}
                </div>
              ))}

              {/* 测试连接 */}
              <div className="flex items-center gap-3">
                <Button
                  variant="secondary"
                  onClick={handleTest}
                  {...(testConn.isPending ? { loading: true } : {})}
                  disabled={!canProceedStep2}
                >
                  测试连接
                </Button>
                {testResult && (
                  testResult.success ? (
                    <span className="flex items-center gap-1 text-sm text-[var(--color-success)]">
                      <CheckCircle className="h-4 w-4" />
                      连接成功{testResult.botName && ` · ${testResult.botName}`}
                    </span>
                  ) : (
                    <span className="flex items-center gap-1 text-sm text-[var(--color-danger)]">
                      连接失败: {testResult.error}
                    </span>
                  )
                )}
              </div>

              <a
                href="#"
                onClick={(e) => e.preventDefault()}
                className="flex items-center gap-1 text-xs text-[var(--color-primary-500)] hover:underline"
              >
                <ExternalLink className="h-3.5 w-3.5" />
                如何创建 {selectedMeta.label} App？
              </a>
            </>
          )}
        </div>
      )}

      {/* Step 3: 路由设置 */}
      {step === 3 && (
        <div className="space-y-5">
          <Select
            label="默认 Agent"
            options={[
              { value: 'agent-1', label: '协调 Agent' },
              { value: 'agent-2', label: '客服 Agent' },
              { value: 'agent-3', label: '技术支持 Agent' },
            ]}
            value={defaultAgentId}
            onChange={() => {}}
          />

          <div>
            <label className="mb-2 block text-sm font-medium text-[var(--text-primary)]">私信策略</label>
            <div className="space-y-2">
              {DM_OPTIONS.map((opt) => (
                <label key={opt.value} className="flex cursor-pointer items-center gap-2.5">
                  <input
                    type="radio"
                    name="dmPolicy"
                    value={opt.value}
                    checked={dmPolicy === opt.value}
                    onChange={(e) => setDmPolicy(e.target.value)}
                    className="accent-[var(--color-primary-500)]"
                  />
                  <span className="text-sm text-[var(--text-primary)]">{opt.label}</span>
                </label>
              ))}
            </div>
          </div>

          <div>
            <label className="mb-2 block text-sm font-medium text-[var(--text-primary)]">群组策略</label>
            <div className="space-y-2">
              {GROUP_OPTIONS.map((opt) => (
                <label key={opt.value} className="flex cursor-pointer items-center gap-2.5">
                  <input
                    type="radio"
                    name="groupPolicy"
                    value={opt.value}
                    checked={groupPolicy === opt.value}
                    onChange={(e) => setGroupPolicy(e.target.value)}
                    className="accent-[var(--color-primary-500)]"
                  />
                  <span className="text-sm text-[var(--text-primary)]">{opt.label}</span>
                </label>
              ))}
            </div>
          </div>
        </div>
      )}
    </Modal>
  )
}
```

### 验证

```bash
pnpm --filter web typecheck
```

---

## Task 7: 消息日志 + 路由规则 + 详情页

**文件:**

- 新建: `apps/web/components/features/channels/message-log-table.tsx`
- 新建: `apps/web/components/features/channels/routing-rules-editor.tsx`
- 新建: `apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/channels/[channelId]/page.tsx`

### Step 1: 新建 `message-log-table.tsx`

```typescript
'use client'

import { useState } from 'react'
import { ArrowUpRight, ArrowDownLeft, CheckCircle, XCircle, ChevronDown, ChevronRight } from 'lucide-react'
import { cn } from '@/lib/utils/cn'
import { Select } from '@/components/ui/select'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { useChannelMessages } from '@/hooks/use-channels'
import type { ChannelMessageFilters, MessageDirection, MessageStatus } from '@/types/api'

interface MessageLogTableProps {
  channelId: string
}

function formatTime(iso: string): string {
  const d = new Date(iso)
  return `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`
}

export function MessageLogTable({ channelId }: MessageLogTableProps) {
  const [filters, setFilters] = useState<ChannelMessageFilters>({ page: 1, pageSize: 50 })
  const [expandedId, setExpandedId] = useState<string | null>(null)

  const { data, isLoading } = useChannelMessages(channelId, filters)

  function setFilter<K extends keyof ChannelMessageFilters>(key: K, value: ChannelMessageFilters[K]) {
    setFilters((f) => ({ ...f, [key]: value, page: 1 }))
  }

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex flex-wrap gap-3">
        <Select
          placeholder="方向"
          options={[
            { value: '', label: '全部方向' },
            { value: 'inbound', label: '入站' },
            { value: 'outbound', label: '出站' },
          ]}
          value={filters.direction ?? ''}
          onChange={(v) => setFilter('direction', (v || undefined) as MessageDirection | undefined)}
          className="w-36"
        />
        <Select
          placeholder="状态"
          options={[
            { value: '', label: '全部状态' },
            { value: 'success', label: '成功' },
            { value: 'failed', label: '失败' },
          ]}
          value={filters.status ?? ''}
          onChange={(v) => setFilter('status', (v || undefined) as MessageStatus | undefined)}
          className="w-32"
        />
        <Input
          placeholder="搜索发送者..."
          value={filters.sender ?? ''}
          onChange={(e) => setFilter('sender', e.target.value || undefined)}
          className="w-48"
        />
      </div>

      {/* Table */}
      {isLoading ? (
        <div className="space-y-2">
          {Array.from({ length: 5 }, (_, i) => (
            <div key={i} className="h-12 animate-pulse rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--surface)]" />
          ))}
        </div>
      ) : !data || data.data.length === 0 ? (
        <div className="flex h-40 items-center justify-center text-sm text-[var(--text-tertiary)]">
          暂无消息记录
        </div>
      ) : (
        <>
          <div className="overflow-hidden rounded-[var(--radius-lg)] border border-[var(--border)]">
            <table className="w-full text-sm">
              <thead className="bg-[var(--surface)]">
                <tr>
                  <th className="w-8 border-b border-[var(--border)] px-3 py-3" />
                  <th className="border-b border-[var(--border)] px-4 py-3 text-left font-semibold text-[var(--text-secondary)]">时间</th>
                  <th className="w-10 border-b border-[var(--border)] px-2 py-3 text-center font-semibold text-[var(--text-secondary)]">方向</th>
                  <th className="w-32 border-b border-[var(--border)] px-4 py-3 text-left font-semibold text-[var(--text-secondary)]">发送者</th>
                  <th className="border-b border-[var(--border)] px-4 py-3 text-left font-semibold text-[var(--text-secondary)]">内容</th>
                  <th className="w-32 border-b border-[var(--border)] px-4 py-3 text-left font-semibold text-[var(--text-secondary)]">Agent</th>
                  <th className="w-20 border-b border-[var(--border)] px-4 py-3 text-left font-semibold text-[var(--text-secondary)]">状态</th>
                </tr>
              </thead>
              <tbody>
                {data.data.map((msg) => (
                  <>
                    <tr
                      key={msg.id}
                      className="cursor-pointer border-b border-[var(--border)] transition-colors last:border-0 hover:bg-[var(--surface)]"
                      onClick={() => setExpandedId(expandedId === msg.id ? null : msg.id)}
                    >
                      <td className="px-3 py-3 text-[var(--text-tertiary)]">
                        {expandedId === msg.id
                          ? <ChevronDown className="h-3.5 w-3.5" />
                          : <ChevronRight className="h-3.5 w-3.5" />}
                      </td>
                      <td className="px-4 py-3 font-mono text-xs text-[var(--text-secondary)]">
                        {formatTime(msg.createdAt)}
                      </td>
                      <td className="px-2 py-3 text-center">
                        {msg.direction === 'outbound'
                          ? <ArrowUpRight className="h-4 w-4 text-[var(--color-primary-400)] mx-auto" />
                          : <ArrowDownLeft className="h-4 w-4 text-[var(--color-success)] mx-auto" />}
                      </td>
                      <td className="px-4 py-3 text-[var(--text-primary)]">{msg.senderName}</td>
                      <td className="max-w-0 px-4 py-3">
                        <p className="truncate text-[var(--text-primary)]">{msg.content}</p>
                      </td>
                      <td className="px-4 py-3">
                        {msg.agentName && (
                          <span className="truncate text-xs text-[var(--text-secondary)]">{msg.agentName}</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {msg.status === 'success'
                          ? <CheckCircle className="h-4 w-4 text-[var(--color-success)]" />
                          : <XCircle className="h-4 w-4 text-[var(--color-danger)]" />}
                      </td>
                    </tr>
                    {expandedId === msg.id && (
                      <tr key={`${msg.id}-detail`} className="bg-[var(--surface)]">
                        <td colSpan={7} className="px-6 py-3">
                          <div className="space-y-1 text-xs text-[var(--text-secondary)]">
                            <p><strong className="text-[var(--text-primary)]">完整内容:</strong> {msg.content}</p>
                            {msg.processingMs && <p><strong className="text-[var(--text-primary)]">处理耗时:</strong> {msg.processingMs}ms</p>}
                            {msg.errorDetail && <p className="text-[var(--color-danger)]"><strong>错误详情:</strong> {msg.errorDetail}</p>}
                          </div>
                        </td>
                      </tr>
                    )}
                  </>
                ))}
              </tbody>
            </table>
          </div>

          {/* Pagination */}
          {data.totalPages > 1 && (
            <div className="flex items-center justify-between text-sm text-[var(--text-secondary)]">
              <span>共 {data.total} 条</span>
              <div className="flex gap-2">
                <Button
                  size="sm"
                  variant="ghost"
                  disabled={filters.page === 1}
                  onClick={() => setFilter('page', (filters.page ?? 1) - 1)}
                >
                  上一页
                </Button>
                <span className="flex items-center px-2">
                  {filters.page} / {data.totalPages}
                </span>
                <Button
                  size="sm"
                  variant="ghost"
                  disabled={filters.page === data.totalPages}
                  onClick={() => setFilter('page', (filters.page ?? 1) + 1)}
                >
                  下一页
                </Button>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  )
}
```

### Step 2: 新建 `routing-rules-editor.tsx`

```typescript
'use client'

import { useState } from 'react'
import { Plus, Trash2, GripVertical } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Select } from '@/components/ui/select'
import { Modal } from '@/components/ui/modal'
import { EmptyState } from '@/components/ui/empty-state'
import { toast } from '@/components/ui/toast'
import {
  useRoutingRules,
  useCreateRoutingRule,
  useDeleteRoutingRule,
} from '@/hooks/use-channels'
import type { RuleField, RuleOperator, CreateRoutingRuleBody } from '@/types/api'

const FIELD_OPTIONS = [
  { value: 'sender', label: '发送者' },
  { value: 'content', label: '内容' },
  { value: 'group', label: '群组' },
  { value: 'channel', label: '渠道' },
]

const OPERATOR_OPTIONS = [
  { value: 'equals', label: '等于' },
  { value: 'contains', label: '包含' },
  { value: 'regex', label: '正则匹配' },
  { value: 'in_list', label: '属于列表' },
]

const AGENT_OPTIONS = [
  { value: 'agent-1', label: '协调 Agent' },
  { value: 'agent-2', label: '客服 Agent' },
  { value: 'agent-3', label: '技术支持 Agent' },
]

interface RoutingRulesEditorProps {
  channelId: string
}

export function RoutingRulesEditor({ channelId }: RoutingRulesEditorProps) {
  const { data: rules, isLoading } = useRoutingRules(channelId)
  const createRule = useCreateRoutingRule(channelId)
  const deleteRule = useDeleteRoutingRule(channelId)

  const [addOpen, setAddOpen] = useState(false)
  const [form, setForm] = useState<CreateRoutingRuleBody>({
    field: 'content',
    operator: 'contains',
    value: '',
    targetAgentId: 'agent-1',
    priority: 10,
  })
  const [deletingId, setDeletingId] = useState<string | null>(null)

  async function handleAdd() {
    if (!form.value.trim()) {
      toast.error('请输入匹配值')
      return
    }
    try {
      await createRule.mutateAsync(form)
      toast.success('规则已添加')
      setAddOpen(false)
      setForm({ field: 'content', operator: 'contains', value: '', targetAgentId: 'agent-1', priority: 10 })
    } catch {
      toast.error('添加失败')
    }
  }

  async function handleDelete() {
    if (!deletingId) return
    try {
      await deleteRule.mutateAsync(deletingId)
      toast.success('规则已删除')
      setDeletingId(null)
    } catch {
      toast.error('删除失败')
    }
  }

  const FIELD_LABEL: Record<RuleField, string> = { sender: '发送者', content: '内容', group: '群组', channel: '渠道' }
  const OP_LABEL: Record<RuleOperator, string> = { equals: '等于', contains: '包含', regex: '正则', in_list: '属于列表' }

  return (
    <div className="space-y-4">
      <div className="flex justify-end">
        <Button size="sm" onClick={() => setAddOpen(true)}>
          <Plus className="mr-1 h-3.5 w-3.5" />
          添加规则
        </Button>
      </div>

      {isLoading ? (
        <div className="space-y-2">
          {Array.from({ length: 3 }, (_, i) => (
            <div key={i} className="h-14 animate-pulse rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--surface)]" />
          ))}
        </div>
      ) : !rules || rules.length === 0 ? (
        <EmptyState
          icon={<Plus className="h-5 w-5" />}
          title="还没有路由规则"
          description="添加规则，将特定消息路由到指定 Agent"
        />
      ) : (
        <div className="overflow-hidden rounded-[var(--radius-lg)] border border-[var(--border)]">
          {rules.map((rule, idx) => {
            const agentName = AGENT_OPTIONS.find((a) => a.value === rule.targetAgentId)?.label ?? rule.targetAgentId
            return (
              <div
                key={rule.id}
                className={cn(
                  'flex items-center gap-3 px-4 py-3',
                  idx < rules.length - 1 && 'border-b border-[var(--border)]',
                  'hover:bg-[var(--surface)]',
                )}
              >
                <GripVertical className="h-4 w-4 shrink-0 text-[var(--text-tertiary)]" />
                <div className="flex-1 text-sm">
                  <span className="text-[var(--text-tertiary)]">当 </span>
                  <span className="font-medium text-[var(--text-primary)]">[{FIELD_LABEL[rule.field]}]</span>
                  <span className="text-[var(--text-tertiary)]"> {OP_LABEL[rule.operator]} </span>
                  <code className="rounded bg-[var(--surface-2)] px-1.5 py-0.5 text-xs">{rule.value}</code>
                  <span className="text-[var(--text-tertiary)]"> → 路由到 </span>
                  <span className="font-medium text-[var(--color-primary-500)]">{agentName}</span>
                </div>
                <span className="text-xs text-[var(--text-tertiary)]">优先级 {rule.priority}</span>
                <button
                  onClick={() => setDeletingId(rule.id)}
                  className="rounded p-1 text-[var(--text-tertiary)] hover:bg-[var(--surface-2)] hover:text-[var(--color-danger)]"
                >
                  <Trash2 className="h-3.5 w-3.5" />
                </button>
              </div>
            )
          })}
          <div className="flex items-center gap-3 border-t border-[var(--border)] bg-[var(--surface)] px-4 py-3 text-sm text-[var(--text-tertiary)]">
            默认: 路由到 <span className="ml-1 font-medium text-[var(--text-primary)]">协调 Agent</span>
          </div>
        </div>
      )}

      {/* Add Rule Modal */}
      <Modal
        open={addOpen}
        onClose={() => setAddOpen(false)}
        title="添加路由规则"
        size="sm"
        footer={
          <div className="flex justify-end gap-2">
            <Button variant="ghost" onClick={() => setAddOpen(false)}>取消</Button>
            <Button onClick={handleAdd} {...(createRule.isPending ? { loading: true } : {})}>添加</Button>
          </div>
        }
      >
        <div className="space-y-3">
          <div className="flex gap-2">
            <Select
              label="字段"
              options={FIELD_OPTIONS}
              value={form.field}
              onChange={(v) => setForm((f) => ({ ...f, field: v as RuleField }))}
            />
            <Select
              label="操作符"
              options={OPERATOR_OPTIONS}
              value={form.operator}
              onChange={(v) => setForm((f) => ({ ...f, operator: v as RuleOperator }))}
            />
          </div>
          <Input
            label="匹配值"
            placeholder="输入匹配内容..."
            value={form.value}
            onChange={(e) => setForm((f) => ({ ...f, value: e.target.value }))}
            fullWidth
          />
          <Select
            label="目标 Agent"
            options={AGENT_OPTIONS}
            value={form.targetAgentId}
            onChange={(v) => setForm((f) => ({ ...f, targetAgentId: v }))}
          />
        </div>
      </Modal>

      {/* Delete Confirm */}
      <Modal
        open={!!deletingId}
        onClose={() => setDeletingId(null)}
        title="删除规则"
        size="sm"
        footer={
          <div className="flex justify-end gap-2">
            <Button variant="ghost" onClick={() => setDeletingId(null)}>取消</Button>
            <Button variant="danger" onClick={handleDelete} {...(deleteRule.isPending ? { loading: true } : {})}>删除</Button>
          </div>
        }
      >
        <p className="text-sm text-[var(--text-secondary)]">确定要删除该路由规则吗？此操作不可撤销。</p>
      </Modal>
    </div>
  )
}

function cn(...args: (string | boolean | undefined | null)[]): string {
  return args.filter(Boolean).join(' ')
}
```

### Step 3: 新建详情页 `channels/[channelId]/page.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { ArrowLeft, Radio, MessageSquare, Settings, GitBranch, BarChart2 } from 'lucide-react'
import { Tabs } from '@/components/ui/tabs'
import { Card } from '@/components/ui/card'
import { MessageLogTable } from '@/components/features/channels/message-log-table'
import { RoutingRulesEditor } from '@/components/features/channels/routing-rules-editor'
import { useChannels, useChannelStats } from '@/hooks/use-channels'

function StatCard({ label, value, sub }: { label: string; value: string | number; sub?: string }) {
  return (
    <Card padding="md">
      <p className="text-xs text-[var(--text-tertiary)]">{label}</p>
      <p className="mt-1 text-2xl font-bold text-[var(--text-primary)]">{value}</p>
      {sub && <p className="mt-0.5 text-xs text-[var(--text-secondary)]">{sub}</p>}
    </Card>
  )
}

const TABS = [
  { key: 'overview', label: '概览', icon: <BarChart2 className="h-4 w-4" /> },
  { key: 'messages', label: '消息日志', icon: <MessageSquare className="h-4 w-4" /> },
  { key: 'rules', label: '路由规则', icon: <GitBranch className="h-4 w-4" /> },
  { key: 'settings', label: '设置', icon: <Settings className="h-4 w-4" /> },
]

export default function ChannelDetailPage() {
  const { wsSlug, slug, channelId } = useParams<{ wsSlug: string; slug: string; channelId: string }>()
  const router = useRouter()
  const [activeTab, setActiveTab] = useState('overview')

  const { data: channels } = useChannels(wsSlug)
  const channel = channels?.find((c) => c.id === channelId)

  const { data: stats } = useChannelStats(channelId)

  return (
    <div className="space-y-6 p-6">
      {/* Back + Header */}
      <div>
        <button
          onClick={() => router.push(`/org/${slug}/ws/${wsSlug}/channels`)}
          className="mb-4 flex items-center gap-1.5 text-sm text-[var(--text-tertiary)] hover:text-[var(--text-primary)]"
        >
          <ArrowLeft className="h-4 w-4" />
          返回渠道列表
        </button>
        <div className="flex items-start gap-3">
          <div className="flex h-10 w-10 items-center justify-center rounded-[var(--radius-md)] bg-[var(--color-primary-50)]">
            <Radio className="h-5 w-5 text-[var(--color-primary-500)]" />
          </div>
          <div>
            <h1 className="text-xl font-semibold text-[var(--text-primary)]">
              {channel?.name ?? channelId}
            </h1>
            {channel && (
              <p className="mt-0.5 text-sm text-[var(--text-secondary)]">
                {channel.type} · {channel.connectedChannels ?? 0} 个频道
              </p>
            )}
          </div>
        </div>
      </div>

      {/* Tabs */}
      <Tabs tabs={TABS} activeKey={activeTab} onChange={setActiveTab} />

      {/* Overview */}
      {activeTab === 'overview' && (
        <div className="space-y-6">
          <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
            <StatCard label="今日入站" value={stats?.todayInbound ?? '—'} />
            <StatCard label="今日出站" value={stats?.todayOutbound ?? '—'} />
            <StatCard label="平均响应" value={stats ? `${stats.avgResponseMs}ms` : '—'} />
            <StatCard label="活跃用户" value={stats?.activeUsers ?? '—'} />
          </div>
          {stats && (
            <Card padding="md" header={<h3 className="text-sm font-semibold text-[var(--text-primary)]">24h 消息量</h3>}>
              <div className="flex items-end gap-px h-24">
                {stats.hourlyTrend.map((pt) => (
                  <div key={pt.hour} className="flex flex-1 flex-col items-center gap-px">
                    <div
                      className="w-full rounded-sm bg-[var(--color-primary-400)]"
                      style={{ height: `${Math.round((pt.inbound / 30) * 100)}%`, minHeight: 2 }}
                    />
                  </div>
                ))}
              </div>
              <div className="mt-1 flex justify-between text-[10px] text-[var(--text-tertiary)]">
                <span>0:00</span><span>6:00</span><span>12:00</span><span>18:00</span><span>23:00</span>
              </div>
            </Card>
          )}
        </div>
      )}

      {/* Messages */}
      {activeTab === 'messages' && <MessageLogTable channelId={channelId} />}

      {/* Rules */}
      {activeTab === 'rules' && <RoutingRulesEditor channelId={channelId} />}

      {/* Settings */}
      {activeTab === 'settings' && (
        <Card padding="md">
          <p className="text-sm text-[var(--text-secondary)]">渠道设置功能开发中...</p>
        </Card>
      )}
    </div>
  )
}
```

### Step 4: 验证

```bash
pnpm --filter web typecheck
```

---

## Task 8: 完整构建验证

```bash
pnpm --filter web build 2>&1 | grep -E "channel|error|Error"
```

预期输出:

```
├ ƒ /org/[slug]/ws/[wsSlug]/channels            X.XX kB      XXX kB
├ ƒ /org/[slug]/ws/[wsSlug]/channels/[channelId]  X.XX kB   XXX kB
```

无 TypeScript 错误，无构建错误。

---

## 验证清单

完成后在开发服务器手动验证:

1. `/org/acme/ws/default/channels`
   - [ ] 显示 5 个渠道卡片（Slack/Discord/Telegram/WebChat/飞书）
   - [ ] 每行: 图标色块、渠道名、状态徽章、子频道数、最近活跃时间
   - [ ] 悬停显示 ⋯ 菜单（配置/断开）
   - [ ] 点击卡片导航到详情页
   - [ ] "添加渠道" 打开 3 步向导
   - [ ] 步骤 1: 10 个渠道卡片，不可用显示"即将推出"
   - [ ] 步骤 2: Slack 显示 3 个输入框 + 测试连接按钮
   - [ ] 步骤 2: Telegram 显示 Webhook URL（只读 + 复制按钮）
   - [ ] 步骤 2: WebChat 显示无需配置提示
   - [ ] 步骤 3: 默认 Agent 选择 + 私信/群组策略
   - [ ] 完成后新渠道出现在列表
   - [ ] 断开确认弹窗 → 删除渠道

2. `/org/acme/ws/default/channels/ch-1`
   - [ ] 返回按钮回到列表
   - [ ] 4 个统计卡片（入站/出站/响应时间/活跃用户）
   - [ ] 24h 柱状图
   - [ ] 消息日志: 表格有方向箭头、发送者、内容、Agent、状态
   - [ ] 点击行展开完整内容 + 处理耗时
   - [ ] 方向/状态筛选器工作正常
   - [ ] 分页正常
   - [ ] 路由规则: 3 条默认规则，规则语句可读
   - [ ] 添加规则弹窗: 字段/操作符/值/Agent 四个字段
   - [ ] 删除规则弹窗确认
