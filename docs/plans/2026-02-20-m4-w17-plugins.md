# M4 W17: æ’ä»¶å¸‚åœºå®ç°è®¡åˆ’

**ç›®æ ‡:** å®ç°å®Œæ•´çš„æ’ä»¶å¸‚åœºä½“éªŒ â€” å·²å®‰è£…æ’ä»¶åˆ—è¡¨ï¼ˆå¯ç”¨/ç¦ç”¨/é…ç½®ï¼‰ã€æ’ä»¶å¸‚åœºï¼ˆåˆ†ç±»ç­›é€‰+æœç´¢+æ’åºï¼‰ã€æ’ä»¶è¯¦æƒ…é¡µï¼ˆæè¿°/æƒé™/æˆªå›¾/è¯„åˆ†/å®‰è£…æŒ‰é’®ï¼‰ã€å®‰è£…æµç¨‹ï¼ˆæƒé™å£°æ˜ + å‚æ•°é…ç½®å¼¹çª—ï¼‰ï¼Œå…¨éƒ¨ä½¿ç”¨ MSW Mockã€‚

**æ¶æ„:** ä¸‰ä¸ªé¡µé¢ï¼š

- `ws/[wsSlug]/plugins/page.tsx` â€” å·²å®‰è£…æ’ä»¶ï¼ˆæ›¿æ¢å ä½é¡µï¼‰
- `ws/[wsSlug]/plugins/marketplace/page.tsx` â€” æ’ä»¶å¸‚åœºï¼ˆæ–°å»ºï¼‰
- `ws/[wsSlug]/plugins/marketplace/[pluginId]/page.tsx` â€” æ’ä»¶è¯¦æƒ…ï¼ˆæ–°å»ºï¼‰

æ–°å¢ `Plugin`ã€`InstalledPlugin`ã€`PluginReview` ç±»å‹ã€‚åˆ›å»ºä¸“ç”¨ `plugin-api.ts`ã€‚React Query é’©å­åœ¨ `use-plugins.ts`ã€‚å››ä¸ªæ–°ç‰¹æ€§ç»„ä»¶ï¼š`plugin-card`ï¼ˆå·²å®‰è£…åˆ—è¡¨è¡Œï¼‰ã€`marketplace-card`ï¼ˆå¸‚åœºå¡ç‰‡ï¼‰ã€`install-wizard`ï¼ˆå®‰è£…å¼¹çª—ï¼‰ã€`plugin-config-form`ï¼ˆé…ç½®è¡¨å•ï¼‰ã€‚å¤ç”¨ç°æœ‰ `Card`ã€`Modal`ã€`Input`ã€`Select`ã€`Tabs`ã€`Button`ã€`EmptyState`ã€`Toast` UI åŸè¯­ã€‚

**æŠ€æœ¯æ ˆ:** Next.js 15 App Routerã€TanStack Query v5ã€MSW v2ã€Tailwind CSS v4ã€Lucide iconsã€‚æ— éœ€æ–°åŒ…ã€‚

---

## æ–‡ä»¶æ˜ å°„

```
æ–°å»º (9):
  apps/web/lib/api/plugin-api.ts
  apps/web/hooks/use-plugins.ts
  apps/web/mocks/factories/plugin.factory.ts
  apps/web/mocks/handlers/plugins.ts
  apps/web/components/features/plugins/plugin-card.tsx
  apps/web/components/features/plugins/marketplace-card.tsx
  apps/web/components/features/plugins/install-wizard.tsx
  apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/plugins/marketplace/page.tsx
  apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/plugins/marketplace/[pluginId]/page.tsx

ä¿®æ”¹ (4):
  apps/web/types/api.ts                   â€” è¿½åŠ  Plugin ç›¸å…³ç±»å‹
  apps/web/lib/api/index.ts               â€” å¯¼å‡º pluginApi
  apps/web/mocks/handlers/index.ts        â€” æ³¨å†Œ pluginHandlers
  apps/web/app/(dashboard)/org/[slug]/ws/[wsSlug]/plugins/page.tsx  â€” æ›¿æ¢å ä½é¡µ
```

## ä¾èµ–å…³ç³»

```
Task 1 (Types + API)
  â”œâ†’ Task 2 (Mocks)
  â”œâ†’ Task 3 (Hooks)
  â”œâ†’ Task 4 (PluginCard + InstallWizard)   â”€â”€â”
  â””â†’ Task 5 (MarketplaceCard)              â”€â”€â”¼â†’ Task 6 (å·²å®‰è£…é¡µ + å¸‚åœºé¡µ)
                                             â””â†’ Task 7 (è¯¦æƒ…é¡µ)
                                                      â†“
                                              Task 8 (Build Verify)
```

æ‰§è¡Œé¡ºåº: 1 â†’ [2, 3, 4, 5] â†’ [6, 7] â†’ 8

---

## Task 1: Types + API Client

**æ–‡ä»¶:**

- ä¿®æ”¹: `apps/web/types/api.ts`
- æ–°å»º: `apps/web/lib/api/plugin-api.ts`
- ä¿®æ”¹: `apps/web/lib/api/index.ts`

### Step 1: åœ¨ `api.ts` æœ«å°¾è¿½åŠ ç±»å‹

```typescript
// â”€â”€â”€ Plugins â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type PluginType =
  | 'tool'
  | 'channel'
  | 'memory'
  | 'hook'
  | 'skill'
  | 'agent-template'
  | 'observability'

export type PluginPricingModel = 'free' | 'one_time' | 'subscription' | 'usage_based'

export type PluginStatus = 'enabled' | 'disabled' | 'error' | 'updating'

export interface PluginConfigField {
  key: string
  label: string
  type: 'text' | 'password' | 'number' | 'boolean' | 'select'
  required: boolean
  placeholder?: string
  description?: string
  options?: Array<{ value: string; label: string }>
  default?: string | number | boolean
}

// å¸‚åœºä¸­çš„æ’ä»¶ï¼ˆå®Œæ•´å®šä¹‰ï¼‰
export interface Plugin {
  id: string
  name: string // e.g. "github-integration"
  displayName: string // e.g. "GitHub Integration"
  description: string
  longDescription?: string
  author: string
  authorAvatar?: string
  icon: string // emoji or URL placeholder
  type: PluginType
  version: string
  pricingModel: PluginPricingModel
  price?: number // åˆ†ï¼ˆäººæ°‘å¸ï¼‰ï¼Œä»… one_time
  monthlyPrice?: number // åˆ†ï¼Œä»… subscription
  trialDays?: number
  rating: number // 0-5
  reviewCount: number
  installCount: number
  tags: string[]
  permissions: string[] // e.g. ["read:agents", "write:memory"]
  configSchema: PluginConfigField[]
  screenshots: string[] // placeholder URLs
  publishedAt: string
  updatedAt: string
  [key: string]: unknown
}

// å·²å®‰è£…æ’ä»¶ï¼ˆworkspace ç»´åº¦ï¼‰
export interface InstalledPlugin {
  id: string
  workspaceId: string
  pluginId: string
  plugin: Plugin
  status: PluginStatus
  config: Record<string, string | number | boolean>
  installedAt: string
  installedBy: string
  [key: string]: unknown
}

export interface PluginReview {
  id: string
  pluginId: string
  authorName: string
  rating: number
  content: string
  createdAt: string
}

export interface InstallPluginBody {
  pluginId: string
  config: Record<string, string | number | boolean>
}

export interface UpdatePluginConfigBody {
  config: Record<string, string | number | boolean>
}

export interface PluginMarketplaceFilters {
  type?: PluginType
  pricingModel?: PluginPricingModel
  search?: string
  sort?: 'popular' | 'rating' | 'newest'
  page?: number
  pageSize?: number
}
```

### Step 2: æ–°å»º `apps/web/lib/api/plugin-api.ts`

```typescript
import { apiClient } from './client'
import type {
  ApiResponse,
  PaginatedResponse,
  Plugin,
  InstalledPlugin,
  PluginReview,
  InstallPluginBody,
  UpdatePluginConfigBody,
  PluginMarketplaceFilters,
} from '@/types/api'

export const pluginApi = {
  // â”€â”€â”€ å¸‚åœº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  listMarketplace: (filters: PluginMarketplaceFilters = {}) => {
    const params = new URLSearchParams()
    if (filters.type) params.set('type', filters.type)
    if (filters.pricingModel) params.set('pricingModel', filters.pricingModel)
    if (filters.search) params.set('search', filters.search)
    if (filters.sort) params.set('sort', filters.sort)
    if (filters.page) params.set('page', String(filters.page))
    if (filters.pageSize) params.set('pageSize', String(filters.pageSize))
    const qs = params.toString()
    return apiClient.get<PaginatedResponse<Plugin>>(`/plugins/marketplace${qs ? `?${qs}` : ''}`)
  },

  getPlugin: (pluginId: string) =>
    apiClient.get<ApiResponse<Plugin>>(`/plugins/marketplace/${pluginId}`),

  getReviews: (pluginId: string) =>
    apiClient.get<ApiResponse<PluginReview[]>>(`/plugins/marketplace/${pluginId}/reviews`),

  // â”€â”€â”€ å·²å®‰è£… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  listInstalled: (workspaceId: string) =>
    apiClient.get<ApiResponse<InstalledPlugin[]>>(`/workspaces/${workspaceId}/plugins`),

  install: (workspaceId: string, body: InstallPluginBody) =>
    apiClient.post<ApiResponse<InstalledPlugin>>(`/workspaces/${workspaceId}/plugins`, body),

  uninstall: (workspaceId: string, pluginId: string) =>
    apiClient.delete<ApiResponse<null>>(`/workspaces/${workspaceId}/plugins/${pluginId}`),

  toggle: (workspaceId: string, pluginId: string, enabled: boolean) =>
    apiClient.patch<ApiResponse<InstalledPlugin>>(
      `/workspaces/${workspaceId}/plugins/${pluginId}`,
      { status: enabled ? 'enabled' : 'disabled' },
    ),

  updateConfig: (workspaceId: string, pluginId: string, body: UpdatePluginConfigBody) =>
    apiClient.patch<ApiResponse<InstalledPlugin>>(
      `/workspaces/${workspaceId}/plugins/${pluginId}/config`,
      body,
    ),
}
```

### Step 3: æ›´æ–° `lib/api/index.ts`

è¿½åŠ ï¼š`export { pluginApi } from './plugin-api'`

---

## Task 2: Mock å·¥å‚ + MSW å¤„ç†å™¨

**æ–‡ä»¶:**

- æ–°å»º: `apps/web/mocks/factories/plugin.factory.ts`
- æ–°å»º: `apps/web/mocks/handlers/plugins.ts`
- ä¿®æ”¹: `apps/web/mocks/handlers/index.ts`

### Step 1: æ–°å»º `plugin.factory.ts`

```typescript
import type {
  Plugin,
  PluginType,
  PluginPricingModel,
  InstalledPlugin,
  PluginReview,
  PluginConfigField,
} from '@/types/api'

let pluginSeq = 1
let installedSeq = 1
let reviewSeq = 1

function daysAgo(n: number): string {
  const d = new Date()
  d.setDate(d.getDate() - n)
  return d.toISOString()
}

function rand(min: number, max: number): number {
  return Math.floor(Math.random() * (max - min + 1)) + min
}

// æ’ä»¶å›¾æ ‡ emoji æ˜ å°„
const TYPE_ICONS: Record<PluginType, string> = {
  tool: 'ğŸ”§',
  channel: 'ğŸ“¡',
  memory: 'ğŸ§ ',
  hook: 'ğŸª',
  skill: 'âš¡',
  'agent-template': 'ğŸ¤–',
  observability: 'ğŸ“Š',
}

const PLUGIN_SEEDS: Array<{
  name: string
  displayName: string
  description: string
  longDescription: string
  author: string
  type: PluginType
  pricingModel: PluginPricingModel
  price?: number
  monthlyPrice?: number
  trialDays?: number
  tags: string[]
  permissions: string[]
  configSchema: PluginConfigField[]
}> = [
  {
    name: 'github-integration',
    displayName: 'GitHub Integration',
    description: 'è®© Agent è¯»å†™ GitHub ä»“åº“ã€ç®¡ç† Issue å’Œ PR',
    longDescription:
      'GitHub Integration æ’ä»¶ä¸º Agent æä¾›å®Œæ•´çš„ GitHub API è®¿é—®èƒ½åŠ›ï¼ŒåŒ…æ‹¬ä»“åº“ç®¡ç†ã€Issue è·Ÿè¸ªã€Pull Request æ“ä½œã€CI/CD è§¦å‘ç­‰ã€‚æ”¯æŒ OAuth å’Œ Personal Access Token ä¸¤ç§è®¤è¯æ–¹å¼ã€‚',
    author: 'NextAI Official',
    type: 'tool',
    pricingModel: 'free',
    tags: ['å¼€å‘å·¥å…·', 'GitHub', 'ä»£ç ç®¡ç†'],
    permissions: ['read:agents', 'write:tools', 'http:external'],
    configSchema: [
      {
        key: 'accessToken',
        label: 'Personal Access Token',
        type: 'password',
        required: true,
        placeholder: 'ghp_...',
        description: 'éœ€è¦ repo, issues, pull_requests æƒé™',
      },
      {
        key: 'defaultOrg',
        label: 'é»˜è®¤ç»„ç»‡',
        type: 'text',
        required: false,
        placeholder: 'your-org',
      },
    ],
  },
  {
    name: 'jira-integration',
    displayName: 'Jira Integration',
    description: 'ä¸ Jira é¡¹ç›®ç®¡ç†ç³»ç»Ÿæ·±åº¦é›†æˆ',
    longDescription:
      'é€šè¿‡ Jira Integrationï¼ŒAgent å¯ä»¥è‡ªåŠ¨åˆ›å»ºå’Œæ›´æ–° Issueã€ç®¡ç† Sprintã€è¿½è¸ªé¡¹ç›®è¿›åº¦ã€‚æ”¯æŒ Jira Cloud å’Œ Server ç‰ˆæœ¬ã€‚',
    author: 'NextAI Official',
    type: 'tool',
    pricingModel: 'subscription',
    monthlyPrice: 2900,
    trialDays: 14,
    tags: ['é¡¹ç›®ç®¡ç†', 'Jira', 'æ•æ·'],
    permissions: ['read:agents', 'write:tools', 'http:external'],
    configSchema: [
      {
        key: 'baseUrl',
        label: 'Jira Base URL',
        type: 'text',
        required: true,
        placeholder: 'https://yourcompany.atlassian.net',
      },
      {
        key: 'email',
        label: 'è´¦å·é‚®ç®±',
        type: 'text',
        required: true,
        placeholder: 'user@example.com',
      },
      {
        key: 'apiToken',
        label: 'API Token',
        type: 'password',
        required: true,
        placeholder: 'Atlassian API Token',
      },
    ],
  },
  {
    name: 'web-search',
    displayName: 'ç½‘é¡µæœç´¢',
    description: 'ä¸º Agent æä¾›å®æ—¶ç½‘é¡µæœç´¢èƒ½åŠ›',
    longDescription:
      'ç½‘é¡µæœç´¢æ’ä»¶é›†æˆ Bing Search APIï¼Œè®© Agent èƒ½å¤Ÿè·å–æœ€æ–°çš„ç½‘ç»œä¿¡æ¯ã€‚æ”¯æŒæ™®é€šæœç´¢ã€æ–°é—»æœç´¢ã€å›¾ç‰‡æœç´¢ç­‰å¤šç§æ¨¡å¼ã€‚',
    author: 'NextAI Official',
    type: 'tool',
    pricingModel: 'usage_based',
    tags: ['æœç´¢', 'ä¿¡æ¯è·å–', 'ç½‘ç»œ'],
    permissions: ['http:external'],
    configSchema: [
      {
        key: 'apiKey',
        label: 'Bing Search API Key',
        type: 'password',
        required: true,
        placeholder: 'API Key',
      },
      {
        key: 'resultsCount',
        label: 'é»˜è®¤è¿”å›æ•°é‡',
        type: 'number',
        required: false,
        default: 5,
      },
    ],
  },
  {
    name: 'pinecone-memory',
    displayName: 'Pinecone è®°å¿†',
    description: 'ä½¿ç”¨ Pinecone ä½œä¸ºå‘é‡è®°å¿†å­˜å‚¨åç«¯',
    longDescription:
      'æ›¿æ¢é»˜è®¤è®°å¿†å­˜å‚¨ï¼Œä½¿ç”¨ Pinecone æ‰˜ç®¡å‘é‡æ•°æ®åº“ã€‚æä¾›æ›´é«˜çš„æ£€ç´¢æ€§èƒ½å’Œå­˜å‚¨å®¹é‡ï¼Œé€‚åˆå¤§è§„æ¨¡éƒ¨ç½²åœºæ™¯ã€‚',
    author: 'Pinecone Labs',
    type: 'memory',
    pricingModel: 'free',
    tags: ['è®°å¿†', 'å‘é‡æ•°æ®åº“', 'Pinecone'],
    permissions: ['write:memory', 'read:memory'],
    configSchema: [
      {
        key: 'apiKey',
        label: 'Pinecone API Key',
        type: 'password',
        required: true,
        placeholder: 'pc-...',
      },
      {
        key: 'environment',
        label: 'ç¯å¢ƒ',
        type: 'text',
        required: true,
        placeholder: 'us-east-1-aws',
      },
      {
        key: 'indexName',
        label: 'Index åç§°',
        type: 'text',
        required: true,
        placeholder: 'nextai-memory',
      },
    ],
  },
  {
    name: 'audit-hook',
    displayName: 'å®¡è®¡æ—¥å¿—é’©å­',
    description: 'è®°å½•æ‰€æœ‰ Agent æ“ä½œåˆ°å¤–éƒ¨ç³»ç»Ÿ',
    longDescription:
      'é€šè¿‡ Webhook å°†æ‰€æœ‰ Agent æ“ä½œï¼ˆå·¥å…·è°ƒç”¨ã€æ¶ˆæ¯æ”¶å‘ã€è®°å¿†è¯»å†™ï¼‰å‘é€åˆ°æ‚¨çš„å®¡è®¡ç³»ç»Ÿã€‚æ”¯æŒ Splunkã€Datadogã€è‡ªå®šä¹‰ HTTP ç«¯ç‚¹ã€‚',
    author: 'Security Team',
    type: 'hook',
    pricingModel: 'free',
    tags: ['å®‰å…¨', 'å®¡è®¡', 'Webhook'],
    permissions: ['read:logs', 'http:external'],
    configSchema: [
      {
        key: 'webhookUrl',
        label: 'Webhook URL',
        type: 'text',
        required: true,
        placeholder: 'https://your-siem.example.com/events',
      },
      {
        key: 'secret',
        label: 'Signing Secret',
        type: 'password',
        required: false,
        placeholder: 'ç”¨äºéªŒè¯è¯·æ±‚æ¥æº',
      },
    ],
  },
  {
    name: 'code-review-skill',
    displayName: 'ä»£ç å®¡æŸ¥æŠ€èƒ½',
    description: 'ä¸“ä¸šçš„ä»£ç å®¡æŸ¥ Agent æ¨¡æ¿',
    longDescription:
      'é¢„è®­ç»ƒçš„ä»£ç å®¡æŸ¥æŠ€èƒ½åŒ…ï¼ŒåŒ…å«ä»£ç è´¨é‡åˆ†æã€å®‰å…¨æ¼æ´æ£€æµ‹ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®ç­‰å®Œæ•´æç¤ºè¯é…ç½®ã€‚å¼€ç®±å³ç”¨ï¼Œæ”¯æŒ 10+ ç¼–ç¨‹è¯­è¨€ã€‚',
    author: 'DevTools Community',
    type: 'skill',
    pricingModel: 'one_time',
    price: 9900,
    tags: ['ä»£ç å®¡æŸ¥', 'å¼€å‘å·¥å…·', 'è´¨é‡'],
    permissions: ['read:agents'],
    configSchema: [],
  },
  {
    name: 'customer-service-template',
    displayName: 'å®¢æœ Agent æ¨¡æ¿',
    description: 'ä¼ä¸šçº§å®¢æœ Agent å®Œæ•´é…ç½®æ¨¡æ¿',
    longDescription:
      'åŒ…å«å®Œæ•´å®¢æœ Agent é…ç½®ï¼šæ¬¢è¿è¯­ã€FAQ çŸ¥è¯†åº“é›†æˆã€å·¥å•åˆ›å»ºã€æƒ…æ„Ÿåˆ†æã€äººå·¥è½¬æ¥é€»è¾‘ã€‚å¯æ ¹æ®ä¼ä¸šå“ç‰Œå®šåˆ¶ã€‚',
    author: 'Enterprise Solutions',
    type: 'agent-template',
    pricingModel: 'subscription',
    monthlyPrice: 9900,
    trialDays: 7,
    tags: ['å®¢æœ', 'Agent æ¨¡æ¿', 'ä¼ä¸š'],
    permissions: ['read:agents', 'write:agents', 'write:memory'],
    configSchema: [
      {
        key: 'brandName',
        label: 'å“ç‰Œåç§°',
        type: 'text',
        required: true,
        placeholder: 'æ‚¨çš„å…¬å¸åç§°',
      },
      {
        key: 'language',
        label: 'ä¸»è¦è¯­è¨€',
        type: 'select',
        required: true,
        options: [
          { value: 'zh', label: 'ä¸­æ–‡' },
          { value: 'en', label: 'English' },
          { value: 'bilingual', label: 'ä¸­è‹±åŒè¯­' },
        ],
        default: 'zh',
      },
    ],
  },
  {
    name: 'grafana-observability',
    displayName: 'Grafana ç›‘æ§',
    description: 'å°† Agent æŒ‡æ ‡æ¨é€åˆ° Grafana',
    longDescription:
      'é€šè¿‡ Prometheus Remote Write åè®®ï¼Œå°† Agent è¿è¡ŒæŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€Token ç”¨é‡ã€é”™è¯¯ç‡ï¼‰å®æ—¶æ¨é€åˆ°æ‚¨çš„ Grafana ç›‘æ§ç³»ç»Ÿã€‚å†…ç½® Agent ä¸“ç”¨ Dashboard æ¨¡æ¿ã€‚',
    author: 'Observability Team',
    type: 'observability',
    pricingModel: 'free',
    tags: ['ç›‘æ§', 'Grafana', 'Prometheus'],
    permissions: ['read:metrics'],
    configSchema: [
      {
        key: 'remoteWriteUrl',
        label: 'Remote Write URL',
        type: 'text',
        required: true,
        placeholder: 'https://prometheus.example.com/api/v1/write',
      },
      {
        key: 'bearerToken',
        label: 'Bearer Token',
        type: 'password',
        required: false,
      },
    ],
  },
]

export function makePlugin(overrides: Partial<Plugin> = {}): Plugin {
  const seed = PLUGIN_SEEDS[(pluginSeq - 1) % PLUGIN_SEEDS.length]!
  const id = `plugin-${pluginSeq++}`
  return {
    id,
    name: seed.name,
    displayName: seed.displayName,
    description: seed.description,
    longDescription: seed.longDescription,
    author: seed.author,
    icon: TYPE_ICONS[seed.type],
    type: seed.type,
    version: `${rand(1, 3)}.${rand(0, 9)}.${rand(0, 9)}`,
    pricingModel: seed.pricingModel,
    ...(seed.price != null ? { price: seed.price } : {}),
    ...(seed.monthlyPrice != null ? { monthlyPrice: seed.monthlyPrice } : {}),
    ...(seed.trialDays != null ? { trialDays: seed.trialDays } : {}),
    rating: Number((3.5 + Math.random() * 1.5).toFixed(1)),
    reviewCount: rand(5, 200),
    installCount: rand(100, 5000),
    tags: seed.tags,
    permissions: seed.permissions,
    configSchema: seed.configSchema,
    screenshots: [],
    publishedAt: daysAgo(rand(30, 365)),
    updatedAt: daysAgo(rand(1, 30)),
    ...overrides,
  }
}

export function makePluginList(): Plugin[] {
  return PLUGIN_SEEDS.map((_, i) => {
    pluginSeq = i + 1
    return makePlugin()
  })
}

const REVIEW_TEXTS = [
  'éå¸¸å¥½ç”¨ï¼Œå¤§å¹…æå‡äº†å›¢é˜Ÿæ•ˆç‡ï¼',
  'é…ç½®ç®€å•ï¼Œæ–‡æ¡£æ¸…æ™°ï¼Œå¼ºçƒˆæ¨èã€‚',
  'åŠŸèƒ½å®Œæ•´ï¼Œå¶å°”æœ‰å° Bugï¼Œä½†æ•´ä½“ä½“éªŒå¾ˆå¥½ã€‚',
  'å¯¹æ¥äº†æˆ‘ä»¬çš„å†…éƒ¨ç³»ç»Ÿï¼Œæ•ˆæœè¶…å‡ºé¢„æœŸã€‚',
  'è¯•ç”¨æœŸå†…å°±å†³å®šè´­ä¹°äº†ï¼Œå€¼å¾—æŠ•èµ„ã€‚',
  'å“åº”é€Ÿåº¦å¾ˆå¿«ï¼Œæ”¯æŒå›¢é˜Ÿä¹Ÿå¾ˆä¸“ä¸šã€‚',
]

const REVIEWER_NAMES = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'Alice', 'Bob', 'Charlie']

export function makePluginReviews(pluginId: string, count = 5): PluginReview[] {
  return Array.from({ length: count }, () => ({
    id: `review-${reviewSeq++}`,
    pluginId,
    authorName: REVIEWER_NAMES[rand(0, REVIEWER_NAMES.length - 1)]!,
    rating: rand(3, 5),
    content: REVIEW_TEXTS[rand(0, REVIEW_TEXTS.length - 1)]!,
    createdAt: daysAgo(rand(1, 90)),
  }))
}

export function makeInstalledPlugin(
  workspaceId: string,
  plugin: Plugin,
  overrides: Partial<InstalledPlugin> = {},
): InstalledPlugin {
  return {
    id: `installed-${installedSeq++}`,
    workspaceId,
    pluginId: plugin.id,
    plugin,
    status: 'enabled',
    config: {},
    installedAt: daysAgo(rand(1, 30)),
    installedBy: 'user-1',
    ...overrides,
  }
}

export function makeInstalledPluginList(workspaceId: string): InstalledPlugin[] {
  const allPlugins = makePluginList()
  // Pre-install first 3 plugins
  return allPlugins.slice(0, 3).map((p) => makeInstalledPlugin(workspaceId, p))
}
```

### Step 2: æ–°å»º `mocks/handlers/plugins.ts`

```typescript
import { http, HttpResponse, delay } from 'msw'
import {
  makePluginList,
  makePlugin,
  makePluginReviews,
  makeInstalledPluginList,
  makeInstalledPlugin,
} from '../factories/plugin.factory'
import type { Plugin, InstalledPlugin } from '@/types/api'

// In-memory stores
const MARKETPLACE_STORE: Plugin[] = makePluginList()
const INSTALLED_STORE: Record<string, InstalledPlugin[]> = {}

function getInstalled(wsId: string): InstalledPlugin[] {
  if (!INSTALLED_STORE[wsId]) INSTALLED_STORE[wsId] = makeInstalledPluginList(wsId)
  return INSTALLED_STORE[wsId]!
}

export const pluginHandlers = [
  // â”€â”€â”€ Marketplace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  http.get('/api/plugins/marketplace', async ({ request }) => {
    await delay(250)
    const url = new URL(request.url)
    const type = url.searchParams.get('type')
    const pricingModel = url.searchParams.get('pricingModel')
    const search = url.searchParams.get('search')?.toLowerCase()
    const sort = url.searchParams.get('sort') ?? 'popular'
    const page = Number(url.searchParams.get('page') ?? 1)
    const pageSize = Number(url.searchParams.get('pageSize') ?? 12)

    let plugins = [...MARKETPLACE_STORE]
    if (type) plugins = plugins.filter((p) => p.type === type)
    if (pricingModel) plugins = plugins.filter((p) => p.pricingModel === pricingModel)
    if (search)
      plugins = plugins.filter(
        (p) =>
          p.displayName.toLowerCase().includes(search) ||
          p.description.toLowerCase().includes(search) ||
          p.tags.some((t) => t.toLowerCase().includes(search)),
      )

    if (sort === 'popular') plugins.sort((a, b) => b.installCount - a.installCount)
    else if (sort === 'rating') plugins.sort((a, b) => b.rating - a.rating)
    else if (sort === 'newest')
      plugins.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime())

    const total = plugins.length
    const slice = plugins.slice((page - 1) * pageSize, page * pageSize)
    return HttpResponse.json({
      data: slice,
      total,
      page,
      pageSize,
      totalPages: Math.ceil(total / pageSize),
    })
  }),

  http.get('/api/plugins/marketplace/:pluginId', async ({ params }) => {
    await delay(150)
    const plugin = MARKETPLACE_STORE.find((p) => p.id === params.pluginId)
    if (!plugin) return HttpResponse.json({ message: 'Not found' }, { status: 404 })
    return HttpResponse.json({ data: plugin })
  }),

  http.get('/api/plugins/marketplace/:pluginId/reviews', async ({ params }) => {
    await delay(200)
    return HttpResponse.json({ data: makePluginReviews(params.pluginId as string) })
  }),

  // â”€â”€â”€ Installed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  http.get('/api/workspaces/:wsId/plugins', async ({ params }) => {
    await delay(200)
    return HttpResponse.json({ data: getInstalled(params.wsId as string) })
  }),

  http.post('/api/workspaces/:wsId/plugins', async ({ params, request }) => {
    await delay(500)
    const body = (await request.json()) as { pluginId: string; config: Record<string, unknown> }
    const wsId = params.wsId as string
    const plugin = MARKETPLACE_STORE.find((p) => p.id === body.pluginId)
    if (!plugin) return HttpResponse.json({ message: 'Plugin not found' }, { status: 404 })

    // Check not already installed
    const existing = getInstalled(wsId).find((i) => i.pluginId === body.pluginId)
    if (existing) return HttpResponse.json({ message: 'Already installed' }, { status: 409 })

    const installed = makeInstalledPlugin(wsId, plugin, {
      config: body.config as Record<string, string | number | boolean>,
    })
    getInstalled(wsId).unshift(installed)
    return HttpResponse.json({ data: installed }, { status: 201 })
  }),

  http.delete('/api/workspaces/:wsId/plugins/:pluginId', async ({ params }) => {
    await delay(300)
    const wsId = params.wsId as string
    const pluginId = params.pluginId as string
    const arr = getInstalled(wsId)
    const idx = arr.findIndex((i) => i.pluginId === pluginId || i.id === pluginId)
    if (idx !== -1) arr.splice(idx, 1)
    return HttpResponse.json({ data: null })
  }),

  http.patch('/api/workspaces/:wsId/plugins/:pluginId', async ({ params, request }) => {
    await delay(250)
    const body = (await request.json()) as Partial<InstalledPlugin>
    const wsId = params.wsId as string
    const pluginId = params.pluginId as string
    const arr = getInstalled(wsId)
    const idx = arr.findIndex((i) => i.pluginId === pluginId || i.id === pluginId)
    if (idx === -1) return HttpResponse.json({ message: 'Not found' }, { status: 404 })
    arr[idx] = { ...arr[idx]!, ...body }
    return HttpResponse.json({ data: arr[idx] })
  }),

  http.patch('/api/workspaces/:wsId/plugins/:pluginId/config', async ({ params, request }) => {
    await delay(300)
    const body = (await request.json()) as { config: Record<string, unknown> }
    const wsId = params.wsId as string
    const pluginId = params.pluginId as string
    const arr = getInstalled(wsId)
    const idx = arr.findIndex((i) => i.pluginId === pluginId || i.id === pluginId)
    if (idx === -1) return HttpResponse.json({ message: 'Not found' }, { status: 404 })
    arr[idx] = {
      ...arr[idx]!,
      config: body.config as Record<string, string | number | boolean>,
    }
    return HttpResponse.json({ data: arr[idx] })
  }),
]
```

### Step 3: æ›´æ–° `mocks/handlers/index.ts`

```typescript
import { pluginHandlers } from './plugins'
// ...åœ¨ handlers æ•°ç»„ä¸­å±•å¼€
...pluginHandlers,
```

---

## Task 3: React Query Hooks

**æ–‡ä»¶:** æ–°å»º `apps/web/hooks/use-plugins.ts`

```typescript
'use client'

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { pluginApi } from '@/lib/api/plugin-api'
import type {
  InstallPluginBody,
  UpdatePluginConfigBody,
  InstalledPlugin,
  PluginMarketplaceFilters,
} from '@/types/api'

// â”€â”€â”€ Marketplace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function useMarketplacePlugins(filters: PluginMarketplaceFilters = {}) {
  return useQuery({
    queryKey: ['plugins-marketplace', filters],
    queryFn: () => pluginApi.listMarketplace(filters),
    staleTime: 60_000,
  })
}

export function usePlugin(pluginId: string) {
  return useQuery({
    queryKey: ['plugin', pluginId],
    queryFn: () => pluginApi.getPlugin(pluginId).then((r) => r.data),
    enabled: !!pluginId,
    staleTime: 120_000,
  })
}

export function usePluginReviews(pluginId: string) {
  return useQuery({
    queryKey: ['plugin-reviews', pluginId],
    queryFn: () => pluginApi.getReviews(pluginId).then((r) => r.data),
    enabled: !!pluginId,
    staleTime: 120_000,
  })
}

// â”€â”€â”€ Installed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function useInstalledPlugins(workspaceId: string) {
  return useQuery({
    queryKey: ['installed-plugins', workspaceId],
    queryFn: () => pluginApi.listInstalled(workspaceId).then((r) => r.data),
    enabled: !!workspaceId,
    staleTime: 30_000,
  })
}

export function useInstallPlugin(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (body: InstallPluginBody) =>
      pluginApi.install(workspaceId, body).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['installed-plugins', workspaceId] })
    },
  })
}

export function useUninstallPlugin(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (pluginId: string) => pluginApi.uninstall(workspaceId, pluginId),
    onMutate: async (pluginId) => {
      await qc.cancelQueries({ queryKey: ['installed-plugins', workspaceId] })
      const previous = qc.getQueryData<InstalledPlugin[]>(['installed-plugins', workspaceId])
      qc.setQueryData<InstalledPlugin[]>(['installed-plugins', workspaceId], (old) =>
        old ? old.filter((i) => i.pluginId !== pluginId && i.id !== pluginId) : [],
      )
      return { previous }
    },
    onError: (_err, _id, ctx) => {
      if (ctx?.previous) qc.setQueryData(['installed-plugins', workspaceId], ctx.previous)
    },
    onSettled: () => {
      void qc.invalidateQueries({ queryKey: ['installed-plugins', workspaceId] })
    },
  })
}

export function useTogglePlugin(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ pluginId, enabled }: { pluginId: string; enabled: boolean }) =>
      pluginApi.toggle(workspaceId, pluginId, enabled).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['installed-plugins', workspaceId] })
    },
  })
}

export function useUpdatePluginConfig(workspaceId: string) {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ pluginId, body }: { pluginId: string; body: UpdatePluginConfigBody }) =>
      pluginApi.updateConfig(workspaceId, pluginId, body).then((r) => r.data),
    onSuccess: () => {
      void qc.invalidateQueries({ queryKey: ['installed-plugins', workspaceId] })
    },
  })
}
```

---

## Task 4: PluginCard + InstallWizard ç»„ä»¶

### Step 1: æ–°å»º `components/features/plugins/plugin-card.tsx`

å·²å®‰è£…æ’ä»¶åˆ—è¡¨ä¸­çš„è¡Œå¡ç‰‡ï¼ˆå¸¦å¯ç”¨/ç¦ç”¨å¼€å…³ã€å¸è½½èœå•ã€é…ç½®å…¥å£ï¼‰ï¼š

```typescript
'use client'

import { useState, useRef, useEffect } from 'react'
import { MoreHorizontal, Settings, Trash2, CheckCircle, XCircle, AlertCircle, RefreshCw } from 'lucide-react'
import { cn } from '@/lib/utils/cn'
import type { InstalledPlugin, PluginStatus, PluginType } from '@/types/api'

interface PluginCardProps {
  plugin: InstalledPlugin
  onToggle?: (pluginId: string, enabled: boolean) => void
  onConfigure?: (plugin: InstalledPlugin) => void
  onUninstall?: (plugin: InstalledPlugin) => void
  toggling?: boolean
}

// çŠ¶æ€é…ç½®
const STATUS_CONFIG: Record<PluginStatus, { label: string; icon: React.ElementType; className: string }> = {
  enabled:  { label: 'è¿è¡Œä¸­', icon: CheckCircle, className: 'text-[var(--color-success)]' },
  disabled: { label: 'å·²ç¦ç”¨', icon: XCircle,     className: 'text-[var(--text-tertiary)]' },
  error:    { label: 'é”™è¯¯',   icon: AlertCircle,  className: 'text-[var(--color-danger)]' },
  updating: { label: 'æ›´æ–°ä¸­', icon: RefreshCw,    className: 'text-[var(--color-warning)]' },
}

// ç±»å‹æ ‡ç­¾é¢œè‰²
const TYPE_COLORS: Record<PluginType, string> = {
  tool:             'bg-blue-50 text-blue-600',
  channel:          'bg-purple-50 text-purple-600',
  memory:           'bg-amber-50 text-amber-600',
  hook:             'bg-red-50 text-red-600',
  skill:            'bg-green-50 text-green-600',
  'agent-template': 'bg-indigo-50 text-indigo-600',
  observability:    'bg-gray-50 text-gray-600',
}

const TYPE_LABELS: Record<PluginType, string> = {
  tool:             'Tool',
  channel:          'Channel',
  memory:           'Memory',
  hook:             'Hook',
  skill:            'Skill',
  'agent-template': 'Template',
  observability:    'Observability',
}

export function PluginCard({ plugin: installed, onToggle, onConfigure, onUninstall, toggling }: PluginCardProps) {
  const [menuOpen, setMenuOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)
  const { plugin } = installed
  const statusCfg = STATUS_CONFIG[installed.status]
  const StatusIcon = statusCfg.icon

  useEffect(() => {
    function handler(e: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) setMenuOpen(false)
    }
    document.addEventListener('mousedown', handler)
    return () => document.removeEventListener('mousedown', handler)
  }, [])

  return (
    <div className="group flex items-center gap-4 rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--bg)] p-4 transition-colors hover:border-[var(--color-primary-200)]">
      {/* Icon */}
      <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-[var(--radius-md)] bg-[var(--surface-2)] text-xl">
        {plugin.icon}
      </div>

      {/* Info */}
      <div className="min-w-0 flex-1">
        <div className="flex flex-wrap items-center gap-2">
          <span className="text-sm font-semibold text-[var(--text-primary)]">{plugin.displayName}</span>
          <span className={cn('rounded px-1.5 py-0.5 text-[11px] font-medium', TYPE_COLORS[plugin.type])}>
            {TYPE_LABELS[plugin.type]}
          </span>
          <span className={cn('flex items-center gap-1 text-xs', statusCfg.className)}>
            <StatusIcon className={cn('h-3.5 w-3.5', installed.status === 'updating' && 'animate-spin')} />
            {statusCfg.label}
          </span>
        </div>
        <p className="mt-0.5 truncate text-xs text-[var(--text-secondary)]">{plugin.description}</p>
        <p className="mt-0.5 text-xs text-[var(--text-tertiary)]">v{plugin.version} Â· by {plugin.author}</p>
      </div>

      {/* Toggle */}
      {onToggle && (
        <button
          role="switch"
          aria-checked={installed.status === 'enabled'}
          disabled={toggling || installed.status === 'updating'}
          onClick={() => onToggle(installed.pluginId, installed.status !== 'enabled')}
          className={cn(
            'relative h-5 w-9 shrink-0 rounded-full transition-colors focus:outline-none disabled:opacity-50',
            installed.status === 'enabled' ? 'bg-[var(--color-success)]' : 'bg-[var(--surface-2)]',
          )}
        >
          <span
            className={cn(
              'absolute top-0.5 h-4 w-4 rounded-full bg-white shadow transition-transform',
              installed.status === 'enabled' ? 'left-[18px]' : 'left-0.5',
            )}
          />
        </button>
      )}

      {/* Menu */}
      <div ref={menuRef} className="relative shrink-0">
        <button
          onClick={() => setMenuOpen((v) => !v)}
          className="rounded-[var(--radius-sm)] p-1 text-[var(--text-tertiary)] opacity-0 transition-opacity group-hover:opacity-100 hover:bg-[var(--surface-2)] hover:text-[var(--text-primary)]"
        >
          <MoreHorizontal className="h-4 w-4" />
        </button>
        {menuOpen && (
          <div
            role="menu"
            className="absolute right-0 top-full z-20 mt-1 w-32 rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--bg)] py-1 shadow-lg"
          >
            {onConfigure && plugin.configSchema.length > 0 && (
              <button
                role="menuitem"
                onClick={() => { setMenuOpen(false); onConfigure(installed) }}
                className="flex w-full items-center gap-2 px-3 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--surface)]"
              >
                <Settings className="h-3.5 w-3.5" />
                é…ç½®
              </button>
            )}
            {onUninstall && (
              <button
                role="menuitem"
                onClick={() => { setMenuOpen(false); onUninstall(installed) }}
                className="flex w-full items-center gap-2 px-3 py-2 text-sm text-[var(--color-danger)] hover:bg-[var(--surface)]"
              >
                <Trash2 className="h-3.5 w-3.5" />
                å¸è½½
              </button>
            )}
          </div>
        )}
      </div>
    </div>
  )
}
```

### Step 2: æ–°å»º `components/features/plugins/install-wizard.tsx`

å®‰è£…æµç¨‹å¼¹çª—ï¼ˆ2æ­¥ï¼šæƒé™å£°æ˜ â†’ å‚æ•°é…ç½®ï¼‰ï¼š

```typescript
'use client'

import { useState } from 'react'
import { Shield, CheckCircle } from 'lucide-react'
import { Modal } from '@/components/ui/modal'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Select } from '@/components/ui/select'
import { cn } from '@/lib/utils/cn'
import type { Plugin, InstallPluginBody } from '@/types/api'

interface InstallWizardProps {
  plugin: Plugin | null
  open: boolean
  onClose: () => void
  onInstall: (body: InstallPluginBody) => void
  loading?: boolean
}

function StepIndicator({ step }: { step: 1 | 2 }) {
  const steps = ['æƒé™ç¡®è®¤', 'å‚æ•°é…ç½®']
  return (
    <div className="mb-6 flex items-center justify-center gap-0">
      {steps.map((label, idx) => {
        const num = idx + 1
        const done = step > num
        const active = step === num
        return (
          <div key={num} className="flex items-center">
            <div className="flex flex-col items-center gap-1">
              <div className={cn(
                'flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold',
                done   && 'bg-[var(--color-success)] text-white',
                active && 'bg-[var(--color-primary-500)] text-white',
                !done && !active && 'bg-[var(--surface-2)] text-[var(--text-tertiary)]',
              )}>
                {done ? <CheckCircle className="h-4 w-4" /> : num}
              </div>
              <span className={cn(
                'whitespace-nowrap text-[11px]',
                active && 'font-semibold text-[var(--color-primary-500)]',
                done   && 'text-[var(--color-success)]',
                !done && !active && 'text-[var(--text-tertiary)]',
              )}>{label}</span>
            </div>
            {idx < steps.length - 1 && (
              <div className={cn(
                'mx-2 mb-4 h-0.5 w-16',
                step > num ? 'bg-[var(--color-primary-500)]' : 'bg-[var(--border)]',
              )} />
            )}
          </div>
        )
      })}
    </div>
  )
}

export function InstallWizard({ plugin, open, onClose, onInstall, loading = false }: InstallWizardProps) {
  const [step, setStep] = useState<1 | 2>(1)
  const [config, setConfig] = useState<Record<string, string | number | boolean>>({})

  if (!plugin) return null

  const hasConfig = plugin.configSchema.length > 0

  function handleClose() {
    setStep(1)
    setConfig({})
    onClose()
  }

  function handleNext() {
    if (step === 1) {
      if (!hasConfig) {
        // No config needed â€” install directly
        onInstall({ pluginId: plugin.id, config: {} })
        return
      }
      setStep(2)
    }
  }

  function handleInstall() {
    onInstall({ pluginId: plugin.id, config })
  }

  function formatPrice(): string {
    if (plugin.pricingModel === 'free') return 'å…è´¹'
    if (plugin.pricingModel === 'one_time' && plugin.price != null)
      return `Â¥${(plugin.price / 100).toFixed(2)} ä¸€æ¬¡æ€§`
    if (plugin.pricingModel === 'subscription' && plugin.monthlyPrice != null)
      return `Â¥${(plugin.monthlyPrice / 100).toFixed(2)}/æœˆ`
    if (plugin.pricingModel === 'usage_based') return 'æŒ‰ç”¨é‡è®¡è´¹'
    return 'å…è´¹'
  }

  return (
    <Modal
      open={open}
      onClose={handleClose}
      title={`å®‰è£… ${plugin.displayName}`}
      size="md"
      footer={
        <div className="flex justify-between">
          <Button
            variant="ghost"
            onClick={step === 1 ? handleClose : () => setStep(1)}
          >
            {step === 1 ? 'å–æ¶ˆ' : 'ä¸Šä¸€æ­¥'}
          </Button>
          {step === 1 ? (
            <Button onClick={handleNext}>
              {hasConfig ? 'ä¸‹ä¸€æ­¥' : 'ç¡®è®¤å®‰è£…'}
            </Button>
          ) : (
            <Button onClick={handleInstall} {...(loading ? { loading: true } : {})}>
              å®‰è£…
            </Button>
          )}
        </div>
      }
    >
      {hasConfig && <StepIndicator step={step} />}

      {/* Step 1: Permissions */}
      {step === 1 && (
        <div className="space-y-4">
          {/* Pricing */}
          {plugin.pricingModel !== 'free' && (
            <div className="rounded-[var(--radius-md)] border border-[var(--color-warning)] bg-amber-50 px-4 py-3">
              <p className="text-sm font-medium text-amber-700">
                ğŸ’° {formatPrice()}
                {plugin.trialDays ? `ï¼ˆ${plugin.trialDays} å¤©å…è´¹è¯•ç”¨ï¼‰` : ''}
              </p>
            </div>
          )}

          {/* Permissions */}
          <div>
            <p className="mb-2 text-sm font-medium text-[var(--text-primary)]">
              <Shield className="mr-1 inline h-4 w-4" />
              æ­¤æ’ä»¶å°†è·å¾—ä»¥ä¸‹æƒé™ï¼š
            </p>
            <ul className="space-y-1.5 rounded-[var(--radius-md)] border border-[var(--border)] bg-[var(--surface)] p-3">
              {plugin.permissions.map((perm) => (
                <li key={perm} className="flex items-center gap-2 text-sm text-[var(--text-secondary)]">
                  <CheckCircle className="h-3.5 w-3.5 shrink-0 text-[var(--color-success)]" />
                  <code className="font-mono text-xs">{perm}</code>
                </li>
              ))}
            </ul>
          </div>

          <p className="text-xs text-[var(--text-tertiary)]">
            by {plugin.author} Â· v{plugin.version} Â· å·²å®‰è£… {plugin.installCount.toLocaleString()} æ¬¡
          </p>
        </div>
      )}

      {/* Step 2: Config */}
      {step === 2 && (
        <div className="space-y-3">
          {plugin.configSchema.map((field) => {
            const value = config[field.key]
            if (field.type === 'select') {
              return (
                <Select
                  key={field.key}
                  label={field.label}
                  options={field.options ?? []}
                  value={value != null ? String(value) : (field.default != null ? String(field.default) : '')}
                  onChange={(v) => setConfig((c) => ({ ...c, [field.key]: v as string }))}
                  fullWidth
                />
              )
            }
            if (field.type === 'boolean') {
              return (
                <div key={field.key} className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-[var(--text-primary)]">{field.label}</p>
                    {field.description && (
                      <p className="text-xs text-[var(--text-tertiary)]">{field.description}</p>
                    )}
                  </div>
                  <button
                    role="switch"
                    aria-checked={Boolean(value ?? field.default)}
                    onClick={() => setConfig((c) => ({ ...c, [field.key]: !Boolean(c[field.key] ?? field.default) }))}
                    className={cn(
                      'relative h-5 w-9 rounded-full transition-colors',
                      Boolean(value ?? field.default) ? 'bg-[var(--color-success)]' : 'bg-[var(--surface-2)]',
                    )}
                  >
                    <span className={cn(
                      'absolute top-0.5 h-4 w-4 rounded-full bg-white shadow transition-transform',
                      Boolean(value ?? field.default) ? 'left-[18px]' : 'left-0.5',
                    )} />
                  </button>
                </div>
              )
            }
            return (
              <Input
                key={field.key}
                label={field.label}
                placeholder={field.placeholder}
                type={field.type === 'password' ? 'password' : field.type === 'number' ? 'number' : 'text'}
                value={value != null ? String(value) : ''}
                onChange={(e) => setConfig((c) => ({
                  ...c,
                  [field.key]: field.type === 'number' ? Number(e.target.value) : e.target.value,
                }))}
                {...(field.description ? { hint: field.description } : {})}
                fullWidth
              />
            )
          })}
        </div>
      )}
    </Modal>
  )
}
```

---

## Task 5: MarketplaceCard ç»„ä»¶

**æ–‡ä»¶:** æ–°å»º `components/features/plugins/marketplace-card.tsx`

å¸‚åœºé¡µé¢ä¸­çš„æ’ä»¶å¡ç‰‡ï¼ˆç½‘æ ¼è§†å›¾ï¼‰ï¼š

```typescript
'use client'

import { Star, Download } from 'lucide-react'
import { cn } from '@/lib/utils/cn'
import { Button } from '@/components/ui/button'
import type { Plugin, PluginType, PluginPricingModel } from '@/types/api'

interface MarketplaceCardProps {
  plugin: Plugin
  isInstalled: boolean
  onInstall?: (plugin: Plugin) => void
  onClick?: (plugin: Plugin) => void
}

const TYPE_COLORS: Record<PluginType, string> = {
  tool:             'bg-blue-50 text-blue-600',
  channel:          'bg-purple-50 text-purple-600',
  memory:           'bg-amber-50 text-amber-600',
  hook:             'bg-red-50 text-red-600',
  skill:            'bg-green-50 text-green-600',
  'agent-template': 'bg-indigo-50 text-indigo-600',
  observability:    'bg-gray-50 text-gray-600',
}

const TYPE_LABELS: Record<PluginType, string> = {
  tool:             'Tool',
  channel:          'Channel',
  memory:           'Memory',
  hook:             'Hook',
  skill:            'Skill',
  'agent-template': 'Template',
  observability:    'Observability',
}

function formatPrice(plugin: Plugin): string {
  if (plugin.pricingModel === 'free') return 'å…è´¹'
  if (plugin.pricingModel === 'one_time' && plugin.price != null)
    return `Â¥${(plugin.price / 100).toFixed(0)}`
  if (plugin.pricingModel === 'subscription' && plugin.monthlyPrice != null)
    return `Â¥${(plugin.monthlyPrice / 100).toFixed(0)}/æœˆ`
  if (plugin.pricingModel === 'usage_based') return 'æŒ‰é‡'
  return 'å…è´¹'
}

function PriceBadge({ model, plugin }: { model: PluginPricingModel; plugin: Plugin }) {
  if (model === 'free') return (
    <span className="rounded-full bg-green-50 px-2 py-0.5 text-[11px] font-medium text-green-600">
      å…è´¹
    </span>
  )
  return (
    <span className="rounded-full bg-amber-50 px-2 py-0.5 text-[11px] font-medium text-amber-600">
      {formatPrice(plugin)}
    </span>
  )
}

export function MarketplaceCard({ plugin, isInstalled, onInstall, onClick }: MarketplaceCardProps) {
  return (
    <div
      className={cn(
        'flex flex-col rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--bg)] p-4 transition-colors',
        onClick && 'cursor-pointer hover:border-[var(--color-primary-200)] hover:shadow-sm',
      )}
      onClick={onClick ? () => onClick(plugin) : undefined}
    >
      {/* Header */}
      <div className="flex items-start gap-3">
        <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-[var(--radius-md)] bg-[var(--surface-2)] text-xl">
          {plugin.icon}
        </div>
        <div className="min-w-0 flex-1">
          <div className="flex flex-wrap items-center gap-1.5">
            <span className="text-sm font-semibold text-[var(--text-primary)]">{plugin.displayName}</span>
            <PriceBadge model={plugin.pricingModel} plugin={plugin} />
          </div>
          <span className={cn('mt-0.5 inline-block rounded px-1.5 py-0.5 text-[11px] font-medium', TYPE_COLORS[plugin.type])}>
            {TYPE_LABELS[plugin.type]}
          </span>
        </div>
      </div>

      {/* Description */}
      <p className="mt-2 flex-1 text-xs leading-relaxed text-[var(--text-secondary)] line-clamp-2">
        {plugin.description}
      </p>

      {/* Tags */}
      <div className="mt-2 flex flex-wrap gap-1">
        {plugin.tags.slice(0, 3).map((tag) => (
          <span key={tag} className="rounded-full bg-[var(--surface-2)] px-2 py-0.5 text-[11px] text-[var(--text-tertiary)]">
            {tag}
          </span>
        ))}
      </div>

      {/* Footer */}
      <div className="mt-3 flex items-center justify-between border-t border-[var(--border)] pt-3">
        <div className="flex items-center gap-3 text-xs text-[var(--text-tertiary)]">
          <span className="flex items-center gap-0.5">
            <Star className="h-3.5 w-3.5 fill-amber-400 text-amber-400" />
            {plugin.rating}
          </span>
          <span className="flex items-center gap-0.5">
            <Download className="h-3.5 w-3.5" />
            {plugin.installCount >= 1000
              ? `${(plugin.installCount / 1000).toFixed(1)}k`
              : plugin.installCount}
          </span>
        </div>
        {isInstalled ? (
          <span className="text-xs font-medium text-[var(--color-success)]">å·²å®‰è£…</span>
        ) : onInstall ? (
          <Button
            size="sm"
            onClick={(e) => { e.stopPropagation(); onInstall(plugin) }}
          >
            å®‰è£…
          </Button>
        ) : null}
      </div>
    </div>
  )
}
```

---

## Task 6: å·²å®‰è£…é¡µ + å¸‚åœºåˆ—è¡¨é¡µ

### Step 1: æ›¿æ¢ `plugins/page.tsx`ï¼ˆå·²å®‰è£…æ’ä»¶ï¼‰

```typescript
'use client'

import { useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { Plus, Puzzle } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Modal } from '@/components/ui/modal'
import { EmptyState } from '@/components/ui/empty-state'
import { PluginCard } from '@/components/features/plugins/plugin-card'
import { InstallWizard } from '@/components/features/plugins/install-wizard'
import { toast } from '@/components/ui/toast'
import {
  useInstalledPlugins,
  useInstallPlugin,
  useUninstallPlugin,
  useTogglePlugin,
  useUpdatePluginConfig,
} from '@/hooks/use-plugins'
import type { InstalledPlugin, Plugin, InstallPluginBody } from '@/types/api'

export default function PluginsPage() {
  const { wsSlug, slug } = useParams<{ wsSlug: string; slug: string }>()
  const router = useRouter()

  const { data: installed, isLoading } = useInstalledPlugins(wsSlug)
  const installPlugin = useInstallPlugin(wsSlug)
  const uninstallPlugin = useUninstallPlugin(wsSlug)
  const togglePlugin = useTogglePlugin(wsSlug)
  const updateConfig = useUpdatePluginConfig(wsSlug)

  const [uninstalling, setUninstalling] = useState<InstalledPlugin | null>(null)
  const [configuring, setConfiguring] = useState<InstalledPlugin | null>(null)
  const [wizardPlugin, setWizardPlugin] = useState<Plugin | null>(null)

  async function handleToggle(pluginId: string, enabled: boolean) {
    try {
      await togglePlugin.mutateAsync({ pluginId, enabled })
    } catch {
      toast.error('æ“ä½œå¤±è´¥')
    }
  }

  async function handleUninstall() {
    if (!uninstalling) return
    try {
      await uninstallPlugin.mutateAsync(uninstalling.pluginId)
      toast.success('æ’ä»¶å·²å¸è½½')
      setUninstalling(null)
    } catch {
      toast.error('å¸è½½å¤±è´¥')
    }
  }

  async function handleInstall(body: InstallPluginBody) {
    try {
      await installPlugin.mutateAsync(body)
      toast.success('æ’ä»¶å·²å®‰è£…')
      setWizardPlugin(null)
    } catch {
      toast.error('å®‰è£…å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  async function handleUpdateConfig(body: InstallPluginBody) {
    if (!configuring) return
    try {
      await updateConfig.mutateAsync({ pluginId: configuring.pluginId, body: { config: body.config } })
      toast.success('é…ç½®å·²æ›´æ–°')
      setConfiguring(null)
    } catch {
      toast.error('æ›´æ–°å¤±è´¥')
    }
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-xl font-semibold text-[var(--text-primary)]">å·²å®‰è£…æ’ä»¶</h1>
          <p className="mt-1 text-sm text-[var(--text-secondary)]">
            ç®¡ç† Workspace ä¸­å·²å®‰è£…çš„æ’ä»¶
          </p>
        </div>
        <Button onClick={() => router.push(`/org/${slug}/ws/${wsSlug}/plugins/marketplace`)}>
          <Plus className="mr-1.5 h-4 w-4" />
          æµè§ˆå¸‚åœº
        </Button>
      </div>

      {/* Content */}
      {isLoading ? (
        <div className="space-y-3">
          {Array.from({ length: 3 }, (_, i) => (
            <div key={i} className="h-20 animate-pulse rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--surface)]" />
          ))}
        </div>
      ) : !installed || installed.length === 0 ? (
        <EmptyState
          icon={<Puzzle className="h-6 w-6" />}
          title="è¿˜æ²¡æœ‰å®‰è£…ä»»ä½•æ’ä»¶"
          description="å‰å¾€æ’ä»¶å¸‚åœºï¼Œä¸º Agent æ‰©å±•æ›´å¤šèƒ½åŠ›"
          action={
            <Button size="sm" onClick={() => router.push(`/org/${slug}/ws/${wsSlug}/plugins/marketplace`)}>
              <Plus className="mr-1 h-3.5 w-3.5" />
              æµè§ˆå¸‚åœº
            </Button>
          }
        />
      ) : (
        <div className="space-y-3">
          {installed.map((item) => (
            <PluginCard
              key={item.id}
              plugin={item}
              onToggle={handleToggle}
              onConfigure={(p) => setConfiguring(p)}
              onUninstall={(p) => setUninstalling(p)}
              {...(togglePlugin.isPending ? { toggling: true } : {})}
            />
          ))}
        </div>
      )}

      {/* Uninstall Confirm */}
      <Modal
        open={!!uninstalling}
        onClose={() => setUninstalling(null)}
        title="å¸è½½æ’ä»¶"
        size="sm"
        footer={
          <div className="flex justify-end gap-2">
            <Button variant="ghost" onClick={() => setUninstalling(null)}>å–æ¶ˆ</Button>
            <Button variant="danger" onClick={handleUninstall} {...(uninstallPlugin.isPending ? { loading: true } : {})}>
              å¸è½½
            </Button>
          </div>
        }
      >
        <p className="text-sm text-[var(--text-secondary)]">
          ç¡®å®šè¦å¸è½½æ’ä»¶ <strong>{uninstalling?.plugin.displayName}</strong> å—ï¼Ÿ
          æ‰€æœ‰ç›¸å…³é…ç½®å°†è¢«åˆ é™¤ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚
        </p>
      </Modal>

      {/* Config Wizard */}
      <InstallWizard
        plugin={configuring?.plugin ?? null}
        open={!!configuring}
        onClose={() => setConfiguring(null)}
        onInstall={handleUpdateConfig}
        {...(updateConfig.isPending ? { loading: true } : {})}
      />
    </div>
  )
}
```

### Step 2: æ–°å»º `plugins/marketplace/page.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { Search, SlidersHorizontal } from 'lucide-react'
import { Input } from '@/components/ui/input'
import { Select } from '@/components/ui/select'
import { Button } from '@/components/ui/button'
import { EmptyState } from '@/components/ui/empty-state'
import { MarketplaceCard } from '@/components/features/plugins/marketplace-card'
import { InstallWizard } from '@/components/features/plugins/install-wizard'
import { toast } from '@/components/ui/toast'
import { useMarketplacePlugins, useInstalledPlugins, useInstallPlugin } from '@/hooks/use-plugins'
import type { Plugin, PluginType, PluginPricingModel, PluginMarketplaceFilters, InstallPluginBody } from '@/types/api'

const TYPE_OPTIONS = [
  { value: '', label: 'å…¨éƒ¨ç±»å‹' },
  { value: 'tool', label: 'Tool' },
  { value: 'channel', label: 'Channel' },
  { value: 'memory', label: 'Memory' },
  { value: 'hook', label: 'Hook' },
  { value: 'skill', label: 'Skill' },
  { value: 'agent-template', label: 'Agent æ¨¡æ¿' },
  { value: 'observability', label: 'Observability' },
]

const PRICING_OPTIONS = [
  { value: '', label: 'å…¨éƒ¨ä»·æ ¼' },
  { value: 'free', label: 'å…è´¹' },
  { value: 'one_time', label: 'ä¹°æ–­' },
  { value: 'subscription', label: 'è®¢é˜…' },
  { value: 'usage_based', label: 'æŒ‰é‡' },
]

const SORT_OPTIONS = [
  { value: 'popular', label: 'æœ€å—æ¬¢è¿' },
  { value: 'rating', label: 'è¯„åˆ†æœ€é«˜' },
  { value: 'newest', label: 'æœ€æ–°å‘å¸ƒ' },
]

export default function MarketplacePage() {
  const { wsSlug } = useParams<{ wsSlug: string }>()
  const router = useRouter()

  const [filters, setFilters] = useState<PluginMarketplaceFilters>({ sort: 'popular', pageSize: 12 })
  const [installing, setInstalling] = useState<Plugin | null>(null)

  const { data, isLoading } = useMarketplacePlugins(filters)
  const { data: installed } = useInstalledPlugins(wsSlug)
  const installPlugin = useInstallPlugin(wsSlug)

  const installedIds = new Set(installed?.map((i) => i.pluginId) ?? [])

  function setFilter<K extends keyof PluginMarketplaceFilters>(key: K, value: PluginMarketplaceFilters[K]) {
    setFilters((f) => ({ ...f, [key]: value }))
  }

  async function handleInstall(body: InstallPluginBody) {
    try {
      await installPlugin.mutateAsync(body)
      toast.success('æ’ä»¶å·²å®‰è£…')
      setInstalling(null)
    } catch {
      toast.error('å®‰è£…å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div>
        <h1 className="text-xl font-semibold text-[var(--text-primary)]">æ’ä»¶å¸‚åœº</h1>
        <p className="mt-1 text-sm text-[var(--text-secondary)]">
          å‘ç°å¹¶å®‰è£…æ‰©å±• Agent èƒ½åŠ›çš„æ’ä»¶
        </p>
      </div>

      {/* Filters */}
      <div className="flex flex-wrap items-center gap-3">
        <div className="flex-1 min-w-48 max-w-72">
          <Input
            placeholder="æœç´¢æ’ä»¶..."
            value={filters.search ?? ''}
            onChange={(e) => setFilter('search', e.target.value || undefined)}
            leftIcon={<Search className="h-4 w-4" />}
            fullWidth
          />
        </div>
        <div className="w-36">
          <Select
            options={TYPE_OPTIONS}
            value={filters.type ?? ''}
            onChange={(v) => setFilter('type', ((v as string) || undefined) as PluginType | undefined)}
            leftIcon={<SlidersHorizontal className="h-4 w-4" />}
            fullWidth
          />
        </div>
        <div className="w-32">
          <Select
            options={PRICING_OPTIONS}
            value={filters.pricingModel ?? ''}
            onChange={(v) => setFilter('pricingModel', ((v as string) || undefined) as PluginPricingModel | undefined)}
            fullWidth
          />
        </div>
        <div className="w-32">
          <Select
            options={SORT_OPTIONS}
            value={filters.sort ?? 'popular'}
            onChange={(v) => setFilter('sort', v as PluginMarketplaceFilters['sort'])}
            fullWidth
          />
        </div>
      </div>

      {/* Grid */}
      {isLoading ? (
        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {Array.from({ length: 8 }, (_, i) => (
            <div key={i} className="h-48 animate-pulse rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--surface)]" />
          ))}
        </div>
      ) : !data || data.data.length === 0 ? (
        <EmptyState
          icon={<Search className="h-6 w-6" />}
          title="æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ’ä»¶"
          description="å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶"
          action={
            <Button size="sm" variant="ghost" onClick={() => setFilters({ sort: 'popular', pageSize: 12 })}>
              æ¸…é™¤ç­›é€‰
            </Button>
          }
        />
      ) : (
        <>
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {data.data.map((plugin) => (
              <MarketplaceCard
                key={plugin.id}
                plugin={plugin}
                isInstalled={installedIds.has(plugin.id)}
                onInstall={(p) => setInstalling(p)}
                onClick={(p) => router.push(`${p.id}`)}
              />
            ))}
          </div>

          {/* Pagination */}
          {data.totalPages > 1 && (
            <div className="flex items-center justify-center gap-2 text-sm text-[var(--text-secondary)]">
              <Button
                size="sm"
                variant="ghost"
                disabled={!filters.page || filters.page <= 1}
                onClick={() => setFilter('page', (filters.page ?? 1) - 1)}
              >
                ä¸Šä¸€é¡µ
              </Button>
              <span>ç¬¬ {filters.page ?? 1} / {data.totalPages} é¡µ</span>
              <Button
                size="sm"
                variant="ghost"
                disabled={filters.page === data.totalPages}
                onClick={() => setFilter('page', (filters.page ?? 1) + 1)}
              >
                ä¸‹ä¸€é¡µ
              </Button>
            </div>
          )}
        </>
      )}

      {/* Install Wizard */}
      <InstallWizard
        plugin={installing}
        open={!!installing}
        onClose={() => setInstalling(null)}
        onInstall={handleInstall}
        {...(installPlugin.isPending ? { loading: true } : {})}
      />
    </div>
  )
}
```

---

## Task 7: æ’ä»¶è¯¦æƒ…é¡µ

**æ–‡ä»¶:** æ–°å»º `plugins/marketplace/[pluginId]/page.tsx`

4åŒºå¸ƒå±€ï¼šå¤´éƒ¨ä¿¡æ¯å¡ + å·¦ä¾§ä»‹ç» + å³ä¾§æ“ä½œé¢æ¿ + åº•éƒ¨è¯„ä»·åˆ—è¡¨ã€‚

```typescript
'use client'

import { useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { ArrowLeft, Star, Download, CheckCircle, Shield } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card } from '@/components/ui/card'
import { Tabs } from '@/components/ui/tabs'
import { InstallWizard } from '@/components/features/plugins/install-wizard'
import { toast } from '@/components/ui/toast'
import {
  usePlugin,
  usePluginReviews,
  useInstalledPlugins,
  useInstallPlugin,
  useUninstallPlugin,
} from '@/hooks/use-plugins'
import type { InstallPluginBody, PluginType } from '@/types/api'

const TYPE_LABELS: Record<PluginType, string> = {
  tool: 'Tool', channel: 'Channel', memory: 'Memory',
  hook: 'Hook', skill: 'Skill', 'agent-template': 'Agent æ¨¡æ¿', observability: 'Observability',
}

function StarRating({ rating }: { rating: number }) {
  return (
    <div className="flex items-center gap-0.5">
      {[1,2,3,4,5].map((s) => (
        <Star
          key={s}
          className={`h-4 w-4 ${s <= Math.round(rating) ? 'fill-amber-400 text-amber-400' : 'text-[var(--border)]'}`}
        />
      ))}
      <span className="ml-1 text-sm text-[var(--text-secondary)]">{rating}</span>
    </div>
  )
}

const DETAIL_TABS = [
  { key: 'overview', label: 'æ¦‚è§ˆ' },
  { key: 'permissions', label: 'æƒé™' },
  { key: 'reviews', label: 'è¯„ä»·' },
]

export default function PluginDetailPage() {
  const { wsSlug, pluginId } = useParams<{ wsSlug: string; pluginId: string }>()
  const router = useRouter()
  const [activeTab, setActiveTab] = useState('overview')
  const [installing, setInstalling] = useState(false)

  const { data: plugin, isLoading } = usePlugin(pluginId)
  const { data: reviews } = usePluginReviews(pluginId)
  const { data: installed } = useInstalledPlugins(wsSlug)
  const installPlugin = useInstallPlugin(wsSlug)
  const uninstallPlugin = useUninstallPlugin(wsSlug)

  const isInstalled = installed?.some((i) => i.pluginId === pluginId) ?? false

  async function handleInstall(body: InstallPluginBody) {
    try {
      await installPlugin.mutateAsync(body)
      toast.success('æ’ä»¶å·²å®‰è£…')
      setInstalling(false)
    } catch {
      toast.error('å®‰è£…å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  async function handleUninstall() {
    try {
      await uninstallPlugin.mutateAsync(pluginId)
      toast.success('æ’ä»¶å·²å¸è½½')
    } catch {
      toast.error('å¸è½½å¤±è´¥')
    }
  }

  function formatPrice(): string {
    if (!plugin) return ''
    if (plugin.pricingModel === 'free') return 'å…è´¹'
    if (plugin.pricingModel === 'one_time' && plugin.price != null)
      return `Â¥${(plugin.price / 100).toFixed(2)} ä¸€æ¬¡æ€§ä¹°æ–­`
    if (plugin.pricingModel === 'subscription' && plugin.monthlyPrice != null)
      return `Â¥${(plugin.monthlyPrice / 100).toFixed(2)}/æœˆ${plugin.trialDays ? `ï¼ˆ${plugin.trialDays}å¤©å…è´¹è¯•ç”¨ï¼‰` : ''}`
    if (plugin.pricingModel === 'usage_based') return 'æŒ‰ç”¨é‡è®¡è´¹'
    return 'å…è´¹'
  }

  if (isLoading) {
    return (
      <div className="p-6">
        <div className="h-40 animate-pulse rounded-[var(--radius-lg)] bg-[var(--surface)]" />
      </div>
    )
  }

  if (!plugin) {
    return (
      <div className="flex h-64 items-center justify-center text-sm text-[var(--text-tertiary)]">
        æ’ä»¶ä¸å­˜åœ¨
      </div>
    )
  }

  return (
    <div className="space-y-6 p-6">
      {/* Back */}
      <button
        onClick={() => router.back()}
        className="flex items-center gap-1.5 text-sm text-[var(--text-tertiary)] hover:text-[var(--text-primary)]"
      >
        <ArrowLeft className="h-4 w-4" />
        è¿”å›å¸‚åœº
      </button>

      {/* Hero */}
      <div className="flex items-start gap-4 rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--bg)] p-6">
        <div className="flex h-16 w-16 shrink-0 items-center justify-center rounded-[var(--radius-lg)] bg-[var(--surface-2)] text-3xl">
          {plugin.icon}
        </div>
        <div className="flex-1">
          <div className="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h1 className="text-xl font-semibold text-[var(--text-primary)]">{plugin.displayName}</h1>
              <p className="mt-0.5 text-sm text-[var(--text-secondary)]">by {plugin.author}</p>
            </div>
            <div className="flex items-center gap-2">
              {isInstalled ? (
                <>
                  <span className="flex items-center gap-1 text-sm text-[var(--color-success)]">
                    <CheckCircle className="h-4 w-4" />
                    å·²å®‰è£…
                  </span>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={handleUninstall}
                    {...(uninstallPlugin.isPending ? { loading: true } : {})}
                  >
                    å¸è½½
                  </Button>
                </>
              ) : (
                <Button onClick={() => setInstalling(true)}>
                  å®‰è£…æ’ä»¶
                </Button>
              )}
            </div>
          </div>

          <div className="mt-3 flex flex-wrap items-center gap-4 text-sm text-[var(--text-secondary)]">
            <StarRating rating={plugin.rating} />
            <span className="flex items-center gap-1">
              <Download className="h-4 w-4" />
              {plugin.installCount.toLocaleString()} æ¬¡å®‰è£…
            </span>
            <span className="rounded px-2 py-0.5 text-xs font-medium bg-[var(--surface-2)] text-[var(--text-secondary)]">
              {TYPE_LABELS[plugin.type]}
            </span>
            <span className="font-medium text-[var(--color-primary-500)]">{formatPrice()}</span>
          </div>

          <div className="mt-2 flex flex-wrap gap-1">
            {plugin.tags.map((tag) => (
              <span key={tag} className="rounded-full bg-[var(--surface-2)] px-2 py-0.5 text-xs text-[var(--text-tertiary)]">
                {tag}
              </span>
            ))}
          </div>
        </div>
      </div>

      {/* Tabs */}
      <Tabs tabs={DETAIL_TABS} activeKey={activeTab} onChange={setActiveTab} />

      {/* Overview */}
      {activeTab === 'overview' && (
        <Card padding="md">
          <h3 className="mb-3 text-sm font-semibold text-[var(--text-primary)]">æ’ä»¶ä»‹ç»</h3>
          <p className="whitespace-pre-line text-sm leading-relaxed text-[var(--text-secondary)]">
            {plugin.longDescription ?? plugin.description}
          </p>
          <div className="mt-4 grid grid-cols-2 gap-3 border-t border-[var(--border)] pt-4 text-xs text-[var(--text-secondary)] sm:grid-cols-4">
            <div><span className="text-[var(--text-tertiary)]">ç‰ˆæœ¬</span><p className="mt-0.5 font-medium">v{plugin.version}</p></div>
            <div><span className="text-[var(--text-tertiary)]">è¯„åˆ†</span><p className="mt-0.5 font-medium">{plugin.rating} / 5</p></div>
            <div><span className="text-[var(--text-tertiary)]">å‘å¸ƒæ—¶é—´</span><p className="mt-0.5 font-medium">{new Date(plugin.publishedAt).toLocaleDateString('zh-CN')}</p></div>
            <div><span className="text-[var(--text-tertiary)]">æœ€åæ›´æ–°</span><p className="mt-0.5 font-medium">{new Date(plugin.updatedAt).toLocaleDateString('zh-CN')}</p></div>
          </div>
        </Card>
      )}

      {/* Permissions */}
      {activeTab === 'permissions' && (
        <Card padding="md">
          <div className="mb-3 flex items-center gap-2">
            <Shield className="h-4 w-4 text-[var(--text-secondary)]" />
            <h3 className="text-sm font-semibold text-[var(--text-primary)]">æ‰€éœ€æƒé™</h3>
          </div>
          {plugin.permissions.length === 0 ? (
            <p className="text-sm text-[var(--text-tertiary)]">æ­¤æ’ä»¶ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šæƒé™</p>
          ) : (
            <ul className="space-y-2">
              {plugin.permissions.map((perm) => (
                <li key={perm} className="flex items-center gap-2 text-sm">
                  <CheckCircle className="h-4 w-4 shrink-0 text-[var(--color-success)]" />
                  <code className="rounded bg-[var(--surface-2)] px-2 py-0.5 font-mono text-xs">{perm}</code>
                </li>
              ))}
            </ul>
          )}
        </Card>
      )}

      {/* Reviews */}
      {activeTab === 'reviews' && (
        <div className="space-y-3">
          {!reviews || reviews.length === 0 ? (
            <div className="flex h-32 items-center justify-center text-sm text-[var(--text-tertiary)]">
              æš‚æ— è¯„ä»·
            </div>
          ) : (
            reviews.map((review) => (
              <Card key={review.id} padding="md">
                <div className="flex items-start justify-between">
                  <div>
                    <p className="text-sm font-medium text-[var(--text-primary)]">{review.authorName}</p>
                    <p className="text-xs text-[var(--text-tertiary)]">
                      {new Date(review.createdAt).toLocaleDateString('zh-CN')}
                    </p>
                  </div>
                  <div className="flex items-center gap-0.5">
                    {[1,2,3,4,5].map((s) => (
                      <Star
                        key={s}
                        className={`h-3.5 w-3.5 ${s <= review.rating ? 'fill-amber-400 text-amber-400' : 'text-[var(--border)]'}`}
                      />
                    ))}
                  </div>
                </div>
                <p className="mt-2 text-sm text-[var(--text-secondary)]">{review.content}</p>
              </Card>
            ))
          )}
        </div>
      )}

      {/* Install Wizard */}
      <InstallWizard
        plugin={installing ? plugin : null}
        open={installing}
        onClose={() => setInstalling(false)}
        onInstall={handleInstall}
        {...(installPlugin.isPending ? { loading: true } : {})}
      />
    </div>
  )
}
```

---

## Task 8: å®Œæ•´æ„å»ºéªŒè¯

```bash
pnpm --filter web build 2>&1 | grep -E "plugin|error|Error"
```

é¢„æœŸè¾“å‡ºï¼š

```
â”œ Æ’ /org/[slug]/ws/[wsSlug]/plugins                   X.XX kB
â”œ Æ’ /org/[slug]/ws/[wsSlug]/plugins/marketplace       X.XX kB
â”œ Æ’ /org/[slug]/ws/[wsSlug]/plugins/marketplace/[pluginId]  X.XX kB
```

æ—  TypeScript é”™è¯¯ï¼Œæ— æ„å»ºé”™è¯¯ã€‚

---

## æ³¨æ„äº‹é¡¹ï¼ˆé¿å…å¸¸è§é”™è¯¯ï¼‰

1. **`exactOptionalPropertyTypes`** â€” Button `loading` ç”¨æ¡ä»¶å±•å¼€ï¼š`{...(isPending ? { loading: true } : {})}`
2. **Select `onChange` è¿”å› `string | string[]`** â€” è¿‡æ»¤æ—¶ç”¨ `v as string` æˆ– `(v as string) || undefined`
3. **Select æ—  `className` prop** â€” ç”¨ `<div className="w-xx">` åŒ…è£¹ + `fullWidth`
4. **Input `leftIcon` prop** â€” æ£€æŸ¥ Input ç»„ä»¶æ˜¯å¦æ”¯æŒï¼Œå¦‚ä¸æ”¯æŒæ”¹ç”¨åŒ…è£¹ div + absolute å®šä½å›¾æ ‡
5. **`[key: string]: unknown`** â€” `Plugin` å’Œ `InstalledPlugin` å·²åŒ…å«ï¼Œæ»¡è¶³ DataTable çº¦æŸ
6. **marketplace/[pluginId]** ç›®å½•éœ€å…ˆåˆ›å»º

---

## éªŒè¯æ¸…å•

å®Œæˆååœ¨å¼€å‘æœåŠ¡å™¨æ‰‹åŠ¨éªŒè¯ï¼š

1. `/org/acme/ws/default/plugins`
   - [ ] å·²å®‰è£… 3 ä¸ªæ’ä»¶ï¼ˆGitHub/Jira/ç½‘é¡µæœç´¢ï¼‰
   - [ ] æ¯è¡Œï¼šemoji å›¾æ ‡ã€ç±»å‹æ ‡ç­¾ã€çŠ¶æ€å¾½ç« ã€å¯ç”¨/ç¦ç”¨å¼€å…³
   - [ ] å¼€å…³åˆ‡æ¢ â†’ çŠ¶æ€æ›´æ–°
   - [ ] â‹¯ èœå•ï¼šæœ‰é…ç½®é¡¹çš„æ˜¾ç¤º"é…ç½®"ï¼Œæ‰€æœ‰æ’ä»¶æ˜¾ç¤º"å¸è½½"
   - [ ] å¸è½½ç¡®è®¤å¼¹çª— â†’ åˆ—è¡¨æ›´æ–°
   - [ ] é…ç½®å¼¹çª—ï¼šæ ¹æ® configSchema æ¸²æŸ“å¯¹åº”è¾“å…¥æ¡†
   - [ ] "æµè§ˆå¸‚åœº"æŒ‰é’®å¯¼èˆªåˆ°å¸‚åœºé¡µ

2. `/org/acme/ws/default/plugins/marketplace`
   - [ ] ç½‘æ ¼å±•ç¤º 8 ä¸ªæ’ä»¶å¡ç‰‡ï¼ˆå¸¦ emoji/åç§°/ç±»å‹/å®šä»·/è¯„åˆ†/å®‰è£…æ•°ï¼‰
   - [ ] æœç´¢æ¡†ï¼šè¾“å…¥"github"è¿‡æ»¤åˆ° GitHub Integration
   - [ ] ç±»å‹ç­›é€‰ï¼šé€‰"Tool"åªæ˜¾ç¤ºå·¥å…·æ’ä»¶
   - [ ] ä»·æ ¼ç­›é€‰ï¼šé€‰"å…è´¹"åªæ˜¾ç¤ºå…è´¹æ’ä»¶
   - [ ] æ’åºåˆ‡æ¢ï¼ˆæœ€å—æ¬¢è¿/è¯„åˆ†æœ€é«˜/æœ€æ–°ï¼‰
   - [ ] å·²å®‰è£…æ’ä»¶æ˜¾ç¤º"å·²å®‰è£…"è€Œé"å®‰è£…"æŒ‰é’®
   - [ ] ç‚¹å‡»"å®‰è£…"æ‰“å¼€å®‰è£…å‘å¯¼
   - [ ] ç‚¹å‡»å¡ç‰‡å¯¼èˆªåˆ°è¯¦æƒ…é¡µ

3. `/org/acme/ws/default/plugins/marketplace/plugin-1`
   - [ ] Hero åŒºåŸŸï¼šå¤§å›¾æ ‡ã€åç§°ã€ä½œè€…ã€è¯„åˆ†ã€å®‰è£…æ•°ã€å®šä»·ã€æ ‡ç­¾
   - [ ] 3 ä¸ªæ ‡ç­¾é¡µï¼ˆæ¦‚è§ˆ/æƒé™/è¯„ä»·ï¼‰
   - [ ] æ¦‚è§ˆï¼šé•¿æ–‡ä»‹ç» + 4ä¸ªå…ƒæ•°æ®æ ¼å­
   - [ ] æƒé™ï¼šæƒé™åˆ—è¡¨ï¼ˆcode æ ·å¼ï¼‰
   - [ ] è¯„ä»·ï¼š5æ¡è¯„ä»·ï¼Œæ˜¾ç¤ºä½œè€…/æ—¥æœŸ/æ˜Ÿçº§/å†…å®¹
   - [ ] æœªå®‰è£…æ—¶æ˜¾ç¤º"å®‰è£…æ’ä»¶"æŒ‰é’®
   - [ ] å·²å®‰è£…æ—¶æ˜¾ç¤º"å·²å®‰è£…"+ "å¸è½½"æŒ‰é’®
   - [ ] å®‰è£…å‘å¯¼å¼¹çª—æ­£ç¡®å±•ç¤ºï¼ˆæ— é…ç½®ç›´æ¥å®‰è£…/æœ‰é…ç½®èµ°2æ­¥ï¼‰
